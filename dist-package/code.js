"use strict";(()=>{var pe=Object.defineProperty;var _=Object.getOwnPropertySymbols;var me=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable;var P=(e,t,n)=>t in e?pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,C=(e,t)=>{for(var n in t||(t={}))me.call(t,n)&&P(e,n,t[n]);if(_)for(var n of _(t))ge.call(t,n)&&P(e,n,t[n]);return e};var R="2.0.0",u=1e4,S=300;var T={SPACE_ID:"",ENVIRONMENT:"master",CMA_TOKEN:"",CONTENT_TYPE:"translation",KEY_FIELD:"key",VALUE_FIELD:"value",NODE_NAME_PATTERN:"^jams_"};function I(e){if(!e.SPACE_ID||!e.SPACE_ID.trim())return"SPACE_ID is required";if(!e.ENVIRONMENT||!e.ENVIRONMENT.trim())return"ENVIRONMENT is required";if(!e.CMA_TOKEN||!e.CMA_TOKEN.trim())return"CMA_TOKEN is required";if(!e.CONTENT_TYPE||!e.CONTENT_TYPE.trim())return"CONTENT_TYPE is required";if(!e.KEY_FIELD||!e.KEY_FIELD.trim())return"KEY_FIELD is required";if(!e.VALUE_FIELD||!e.VALUE_FIELD.trim())return"VALUE_FIELD is required";if(!e.NODE_NAME_PATTERN||!e.NODE_NAME_PATTERN.trim())return"NODE_NAME_PATTERN is required";try{new RegExp(e.NODE_NAME_PATTERN)}catch(t){return`Invalid regex pattern: ${e.NODE_NAME_PATTERN}`}return null}function ye(e){return e&&typeof e=="object"?C(C({},T),e):C({},T)}async function w(){try{let e=await figma.clientStorage.getAsync("translatorwiz_config");return ye(e)}catch(e){return console.error("Failed to load config from storage:",e),C({},T)}}async function k(e){try{await figma.clientStorage.setAsync("translatorwiz_config",e)}catch(t){throw new Error("Failed to save config to storage")}}async function p(e,t,n=u){return new Promise((r,s)=>{let o=setTimeout(()=>{s(new Error("Request timeout - please check your network connection"))},n);fetch(e,t).then(a=>{clearTimeout(o),r(a)}).catch(a=>{clearTimeout(o),s(a)})})}async function F(e){let t=encodeURIComponent(e.SPACE_ID),n=encodeURIComponent(e.ENVIRONMENT),r=`https://api.contentful.com/spaces/${t}/environments/${n}/locales`,s={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let o=await p(r,s,u);if(!o.ok)throw o.status===401||o.status===403?new Error("Invalid API credentials"):o.status===404?new Error("Space or environment not found"):new Error("Failed to fetch locales");let a=await o.json();if(!a.items||!Array.isArray(a.items))throw new Error("Invalid response format");return a.items.map(i=>({code:i&&typeof i.code=="string"?i.code:"",name:i&&typeof i.name=="string"?i.name:""})).filter(i=>i.code.trim()!==""&&i.name.trim()!=="")}catch(o){throw o instanceof Error?new Error(`Failed to load locales: ${o.message}`):o}}async function $(e){let t=encodeURIComponent(e.SPACE_ID),n=encodeURIComponent(e.ENVIRONMENT),r=`https://api.contentful.com/spaces/${t}/environments/${n}/content_types`,s={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let o=await p(r,s,u);if(!o.ok)throw o.status===401||o.status===403?new Error("Invalid API credentials"):o.status===404?new Error("Space or environment not found"):new Error("Failed to fetch content types");let a=await o.json();if(!a.items||!Array.isArray(a.items))throw new Error("Invalid response format");return a.items}catch(o){throw o instanceof Error?new Error(`Failed to load content types: ${o.message}`):o}}async function M(e,t){let n=encodeURIComponent(e.SPACE_ID),r=encodeURIComponent(e.ENVIRONMENT),s=encodeURIComponent(t),o=`https://api.contentful.com/spaces/${n}/environments/${r}/entries?content_type=${s}&limit=100`,a={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let i=await p(o,a,u);if(!i.ok)throw i.status===401||i.status===403?new Error("Invalid API credentials"):i.status===404?new Error("Content type not found"):new Error("Failed to fetch records");let c=await i.json();if(!c.items||!Array.isArray(c.items))throw new Error("Invalid response format");return c.items}catch(i){throw i instanceof Error?new Error(`Failed to load records: ${i.message}`):i}}async function D(e){let t=encodeURIComponent(e.SPACE_ID),n=encodeURIComponent(e.ENVIRONMENT),r=encodeURIComponent(e.CONTENT_TYPE),s=`https://api.contentful.com/spaces/${t}/environments/${n}/content_types/${r}`,o={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let a=await p(s,o,u);if(!a.ok)return a.status===404?{success:!1,error:"Content type not found"}:{success:!1,error:"Content type check failed"};let i=await a.json(),l=(Array.isArray(i.fields)?i.fields:[]).map(f=>f&&typeof f.id=="string"?f.id:"");return l.includes(e.KEY_FIELD)?l.includes(e.VALUE_FIELD)?{success:!0}:{success:!1,error:"Value field not found in content type"}:{success:!1,error:"Key field not found in content type"}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Content type check failed"}}}async function U(e){let t=encodeURIComponent(e.SPACE_ID),n=encodeURIComponent(e.ENVIRONMENT),r=encodeURIComponent(e.CONTENT_TYPE),s=1e3,o={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let a=`https://api.contentful.com/spaces/${t}/environments/${n}/entries?content_type=${r}&limit=${s}`,i=await p(a,o,u);if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);let c=await i.json(),l=c.total||0,f=[c];if(l>s){let h=Math.ceil((l-s)/s),y=[];for(let d=1;d<=h;d++){let m=d*s,E=`https://api.contentful.com/spaces/${t}/environments/${n}/entries?content_type=${r}&limit=${s}&skip=${m}`;y.push(p(E,o,u).then(g=>g.json()).catch(g=>(console.error(`Failed to fetch page ${d}:`,g),{items:[]})))}let N=await Promise.all(y);f.push(...N)}let x={};for(let h of f)if(h.items&&Array.isArray(h.items))for(let y of h.items){if(y.sys.archivedVersion!==void 0)continue;let N=y.fields||{},d=N[e.KEY_FIELD],m=N[e.VALUE_FIELD],E=null,g=null;d&&typeof d=="object"&&(E=d["en-US"]||d[Object.keys(d)[0]]),m&&typeof m=="object"&&(g=m["en-US"]||m[Object.keys(m)[0]]),E&&g&&(x[E]={value:g,id:y.sys.id})}return x}catch(a){throw a instanceof Error?new Error(`Failed to fetch Contentful items: ${a.message}`):a}}async function O(e,t){let n=encodeURIComponent(e.SPACE_ID),r=encodeURIComponent(e.ENVIRONMENT),s=e.CONTENT_TYPE;try{if(t.isUpdate&&t.entryId){let o=`https://api.contentful.com/spaces/${n}/environments/${r}/entries/${t.entryId}`,a=await p(o,{headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}},u);if(!a.ok){let f=await a.text();return console.error("[Contentful] Failed to fetch entry for update:",f),{success:!1,error:`Could not fetch entry (${a.status})`,errorDetails:{status:a.status,response:f,operation:"fetch",entryId:t.entryId}}}let c=(await a.json()).sys.version,l=await p(o,{method:"PUT",headers:{Authorization:`Bearer ${e.CMA_TOKEN}`,"Content-Type":"application/vnd.contentful.management.v1+json","X-Contentful-Version":c.toString()},body:JSON.stringify({fields:{[e.KEY_FIELD]:{"en-US":t.key},[e.VALUE_FIELD]:{"en-US":t.value}}})},u);if(!l.ok){let f=await l.text();return console.error("[Contentful] Update failed:",f),{success:!1,error:`Update failed (${l.status})`,errorDetails:{status:l.status,response:f,operation:"update",entryId:t.entryId,version:c}}}return{success:!0}}else{let o=`https://api.contentful.com/spaces/${n}/environments/${r}/entries`,a=await p(o,{method:"POST",headers:{Authorization:`Bearer ${e.CMA_TOKEN}`,"Content-Type":"application/vnd.contentful.management.v1+json","X-Contentful-Content-Type":s},body:JSON.stringify({fields:{[e.KEY_FIELD]:{"en-US":t.key},[e.VALUE_FIELD]:{"en-US":t.value}}})},u);if(!a.ok){let i=await a.text();return console.error("[Contentful] Create failed:",i),{success:!1,error:`Create failed (${a.status})`,errorDetails:{status:a.status,response:i,operation:"create",key:t.key}}}return{success:!0}}}catch(o){return console.error("[Contentful] Exception:",o),o instanceof Error?{success:!1,error:o.message,errorDetails:{exception:o.name,stack:o.stack,operation:t.isUpdate?"update":"create"}}:{success:!1,error:"Unknown error occurred",errorDetails:{exception:String(o)}}}}function A(e){try{if(!figma.currentPage)return 0;let t=new RegExp(e.NODE_NAME_PATTERN);return figma.currentPage.findAllWithCriteria({types:["TEXT"]}).filter(s=>s.name&&t.test(s.name)).length}catch(t){return console.error("Error counting translatable nodes:",t),0}}function L(){return figma.currentPage.findAllWithCriteria({types:["TEXT"]}).map(t=>({id:t.id,name:t.name,characters:t.characters}))}function b(e){let t=new RegExp(e.NODE_NAME_PATTERN);return figma.currentPage.findAll(r=>r.type==="TEXT"&&t.test(r.name)).map(r=>({id:r.id,name:r.name,characters:r.characters}))}async function V(e,t){let n=[];for(let r of e)try{let s=await figma.getNodeByIdAsync(r.node);if(!s||s.type!=="TEXT"){n.push(`Node not found: ${r.node}`);continue}if(s.locked){n.push(`Node is locked: ${s.name}`);continue}let o=t[r.field];if(o==null)continue;let a=String(o);if(s.hasMissingFont){n.push(`Missing font in node: ${s.name}`);continue}let i=s.fontName;if(i===figma.mixed){let c=new Set;for(let l=0;l<s.characters.length;l++){let f=s.getRangeFontName(l,l+1);c.add(`${f.family}:${f.style}`),await figma.loadFontAsync(f)}}else await figma.loadFontAsync(i);s.characters=a}catch(s){let o=s instanceof Error?s.message:"Unknown error";n.push(`Error applying to node: ${o}`)}n.length>0&&console.warn("Some mappings failed:",n)}async function K(e,t){if(!e||!Array.isArray(e)||e.length===0)return{success:!1,count:0,error:"Invalid node IDs"};let n=0,r=[];for(let s of e)try{let o=await figma.getNodeByIdAsync(s);if(!o||!("type"in o)||o.type!=="TEXT"){r.push(`Node ${s}: Not found or not a text node`);continue}let a=o;if(a.hasMissingFont){r.push(`${o.name}: Missing font`);continue}let i=a.fontName;if(i===figma.mixed)for(let c=0;c<a.characters.length;c++){let l=a.getRangeFontName(c,c+1);await figma.loadFontAsync(l)}else await figma.loadFontAsync(i);a.characters=t,n++}catch(o){let a=o instanceof Error?o.message:String(o);r.push(`Node ${s}: ${a}`)}return{success:n>0,count:n,errors:r.length>0?r:void 0,error:n===0?r[0]:void 0}}async function z(e){try{let t=await figma.getNodeByIdAsync(e);t&&"type"in t&&(figma.currentPage.selection=[t],figma.viewport.scrollAndZoomIntoView([t]))}catch(t){console.error("Error selecting node:",t)}}async function Y(){let e=await w();if(figma.ui.postMessage({type:"config-loaded",config:e,version:R}),!I(e)){let n=A(e);figma.ui.postMessage({type:"node-count",count:n})}}function j(e){e()}async function B(e){if(!e){figma.ui.postMessage({type:"config-save-failed",message:"No config provided"});return}let t=I(e);if(t){figma.ui.postMessage({type:"config-save-failed",message:t});return}await k(e),figma.ui.postMessage({type:"config-saved",config:e});let n=A(e);figma.ui.postMessage({type:"node-count",count:n})}async function q(e){if(!e){figma.ui.postMessage({type:"preflight-locales-result",result:{success:!1,error:"No config provided"}});return}try{let t=await F(e);if(t.length===0)throw new Error("No locales found");figma.ui.postMessage({type:"preflight-locales-result",result:{success:!0,message:`Found ${t.length} locale(s)`}})}catch(t){let n=t instanceof Error?t.message:"Failed to fetch locales";figma.ui.postMessage({type:"preflight-locales-result",result:{success:!1,error:n}})}}async function G(e){if(!e){figma.ui.postMessage({type:"preflight-content-result",result:{success:!1,error:"No config provided"}});return}let t=await D(e);t.success?figma.ui.postMessage({type:"preflight-content-result",result:{success:!0,message:"Content type validated"}}):figma.ui.postMessage({type:"preflight-content-result",result:{success:!1,error:t.error}})}async function W(e){if(!e){figma.ui.postMessage({type:"error",message:"Configuration missing"});return}try{let t=await $(e);figma.ui.postMessage({type:"content-types-loaded",contentTypes:t})}catch(t){let n=t instanceof Error?t.message:String(t);figma.ui.postMessage({type:"error",message:n})}}function X(){try{let e=L();figma.ui.postMessage({type:"text-nodes-loaded",nodes:e})}catch(e){let t=e instanceof Error?e.message:String(e);figma.ui.postMessage({type:"error",message:t})}}async function H(e,t){if(!e||!t){figma.ui.postMessage({type:"error",message:"Configuration or content type missing"});return}try{let n=await M(e,t);figma.ui.postMessage({type:"records-loaded",records:n})}catch(n){let r=n instanceof Error?n.message:String(n);figma.ui.postMessage({type:"error",message:r})}}async function J(e,t){if(!e||!t){figma.ui.postMessage({type:"error",message:"Configuration or content types missing"});return}try{let n={};for(let r of t){let s=await M(e,r);n[r]=s}figma.ui.postMessage({type:"multiple-records-loaded",recordsByContentType:n})}catch(n){let r=n instanceof Error?n.message:String(n);figma.ui.postMessage({type:"error",message:r})}}async function Z(e,t){if(!e||!t){figma.ui.postMessage({type:"error",message:"Mappings or record data missing"});return}try{await V(e,t),figma.ui.postMessage({type:"record-applied"})}catch(n){let r=n instanceof Error?n.message:String(n);figma.ui.postMessage({type:"error",message:r})}}function Q(e){if(!e){figma.ui.postMessage({type:"error",message:"Configuration missing"});return}try{let t=b(e);figma.ui.postMessage({type:"translatable-nodes-loaded",nodes:t})}catch(t){let n=t instanceof Error?t.message:String(t);figma.ui.postMessage({type:"error",message:n})}}async function ee(e){if(!e){figma.ui.postMessage({type:"error",message:"Configuration missing"});return}try{let t=await U(e);figma.ui.postMessage({type:"contentful-items-loaded",items:t})}catch(t){let n=t instanceof Error?t.message:String(t);figma.ui.postMessage({type:"error",message:n})}}async function te(e,t){if(!e||!t){figma.ui.postMessage({type:"error",message:"Configuration or item missing"});return}try{let n=t,r=await O(e,n);figma.ui.postMessage({type:"item-saved",key:n.key,success:r.success,error:r.error,errorDetails:r.errorDetails})}catch(n){let r=n instanceof Error?n.message:String(n),s=n instanceof Error?{exception:n.name,stack:n.stack}:{exception:String(n)},o=t;figma.ui.postMessage({type:"item-saved",key:o.key,success:!1,error:r,errorDetails:s})}}async function ne(){let e=await figma.clientStorage.getAsync("window-size-compact");figma.ui.postMessage({type:"window-size-state",isCompact:e||!1})}async function oe(e,t,n){if(e&&t)try{figma.ui.resize(e,t),n!==void 0&&await figma.clientStorage.setAsync("window-size-compact",n)}catch(r){console.error("Failed to resize window:",r)}else console.error("Invalid resize dimensions:",e,t)}async function re(e,t){if(!e||!Array.isArray(e)||e.length===0||t===void 0){figma.ui.postMessage({type:"update-multiple-nodes-result",success:!1,error:"Invalid node IDs or text"});return}let n=await K(e,t);figma.ui.postMessage({type:"update-multiple-nodes-result",success:n.success,count:n.count,errors:n.errors,error:n.error})}async function se(e){e&&await z(e)}function ae(){figma.closePlugin()}var ie=null,ce=0,he=200;function le(e){return async t=>{let n=Date.now(),r=n-ce;if(!((t==null?void 0:t.type)===ie&&r<he)){ie=t==null?void 0:t.type,ce=n;try{if(!t||typeof t!="object"||typeof t.type!="string"){console.error("Invalid message format:",t);return}switch(t.type){case"init":await Y();break;case"plugin-ready":j(e);break;case"save-config":await B(t.config);break;case"preflight-test-locales":await q(t.config);break;case"preflight-check-content":await G(t.config);break;case"load-content-types":await W(t.config);break;case"get-text-nodes":X();break;case"load-records":await H(t.config,t.contentType);break;case"load-multiple-records":await J(t.config,t.contentTypes);break;case"apply-record-to-nodes":await Z(t.mappings,t.recordFields);break;case"get-translatable-nodes":Q(t.config);break;case"get-all-contentful-items":await ee(t.config);break;case"save-contentful-item":await te(t.config,t.item);break;case"get-window-size-state":await ne();break;case"resize-window":await oe(t.width,t.height,t.isCompact);break;case"update-multiple-nodes":await re(t.nodeIds,t.newText);break;case"select-node":await se(t.nodeId);break;case"cancel":ae();break;default:console.warn("Unknown message type:",t.type)}}catch(s){console.error("Message handler error:",s);let o=s instanceof Error?s.message:String(s);try{figma.ui.postMessage({type:"error",message:o})}catch(a){console.error("Failed to send error to UI:",a)}}}}}figma.showUI(__html__,{width:800,height:500,themeColors:!0});(async()=>await figma.loadAllPagesAsync())();var fe=!1,v=null,ue=w();function Ee(){fe||(figma.on("selectionchange",()=>{v&&clearTimeout(v),v=setTimeout(async()=>{try{if(!figma.currentPage)return;let e=figma.currentPage.selection;if(e.length===1&&e[0]&&e[0].type==="TEXT"){let t=e[0],n=await ue;if(n&&n.NODE_NAME_PATTERN)try{if(!new RegExp(n.NODE_NAME_PATTERN).test(t.name))return}catch(s){console.warn("Invalid regex pattern in config:",s);return}let r="";try{r=t.characters}catch(s){console.warn("Could not read text node characters:",s),r="[Unable to read text]"}figma.ui.postMessage({type:"text-node-selected",nodeName:t.name||"[Unnamed]",nodeText:r})}}catch(e){console.error("Selection change handler error:",e)}},S)}),fe=!0)}var de=le(Ee);figma.ui.onmessage=de;figma.ui.onmessage=async e=>{await de(e),e.type==="save-config"&&e.config&&(ue=Promise.resolve(e.config))};})();
