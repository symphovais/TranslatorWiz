"use strict";(()=>{var pe=Object.defineProperty;var P=Object.getOwnPropertySymbols;var me=Object.prototype.hasOwnProperty,ge=Object.prototype.propertyIsEnumerable;var _=(e,t,o)=>t in e?pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,C=(e,t)=>{for(var o in t||(t={}))me.call(t,o)&&_(e,o,t[o]);if(P)for(var o of P(t))ge.call(t,o)&&_(e,o,t[o]);return e};var R="2.0.0",d=1e4,S=300;var w={SPACE_ID:"",ENVIRONMENT:"master",CMA_TOKEN:"",CONTENT_TYPE:"translation",KEY_FIELD:"key",VALUE_FIELD:"value",NODE_NAME_PATTERN:"^jams_"};function M(e){if(!e.SPACE_ID||!e.SPACE_ID.trim())return"SPACE_ID is required";if(!e.ENVIRONMENT||!e.ENVIRONMENT.trim())return"ENVIRONMENT is required";if(!e.CMA_TOKEN||!e.CMA_TOKEN.trim())return"CMA_TOKEN is required";if(!e.CONTENT_TYPE||!e.CONTENT_TYPE.trim())return"CONTENT_TYPE is required";if(!e.KEY_FIELD||!e.KEY_FIELD.trim())return"KEY_FIELD is required";if(!e.VALUE_FIELD||!e.VALUE_FIELD.trim())return"VALUE_FIELD is required";if(!e.NODE_NAME_PATTERN||!e.NODE_NAME_PATTERN.trim())return"NODE_NAME_PATTERN is required";try{new RegExp(e.NODE_NAME_PATTERN)}catch(t){return`Invalid regex pattern: ${e.NODE_NAME_PATTERN}`}return null}function ye(e){return e&&typeof e=="object"?C(C({},w),e):C({},w)}async function I(){try{let e=await figma.clientStorage.getAsync("translatorwiz_config");return ye(e)}catch(e){return console.error("Failed to load config from storage:",e),C({},w)}}async function $(e){try{await figma.clientStorage.setAsync("translatorwiz_config",e)}catch(t){throw new Error("Failed to save config to storage")}}async function p(e,t,o=d){return new Promise((r,s)=>{let n=setTimeout(()=>{s(new Error("Request timeout - please check your network connection"))},o);fetch(e,t).then(a=>{clearTimeout(n),r(a)}).catch(a=>{clearTimeout(n),s(a)})})}async function k(e){let t=encodeURIComponent(e.SPACE_ID),o=encodeURIComponent(e.ENVIRONMENT),r=`https://api.contentful.com/spaces/${t}/environments/${o}/locales`,s={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let n=await p(r,s,d);if(!n.ok)throw n.status===401||n.status===403?new Error("Invalid API credentials"):n.status===404?new Error("Space or environment not found"):new Error("Failed to fetch locales");let a=await n.json();if(!a.items||!Array.isArray(a.items))throw new Error("Invalid response format");return a.items.map(i=>({code:i&&typeof i.code=="string"?i.code:"",name:i&&typeof i.name=="string"?i.name:""})).filter(i=>i.code.trim()!==""&&i.name.trim()!=="")}catch(n){throw n instanceof Error?new Error(`Failed to load locales: ${n.message}`):n}}async function F(e){let t=encodeURIComponent(e.SPACE_ID),o=encodeURIComponent(e.ENVIRONMENT),r=`https://api.contentful.com/spaces/${t}/environments/${o}/content_types`,s={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let n=await p(r,s,d);if(!n.ok)throw n.status===401||n.status===403?new Error("Invalid API credentials"):n.status===404?new Error("Space or environment not found"):new Error("Failed to fetch content types");let a=await n.json();if(!a.items||!Array.isArray(a.items))throw new Error("Invalid response format");return a.items}catch(n){throw n instanceof Error?new Error(`Failed to load content types: ${n.message}`):n}}async function A(e,t){let o=encodeURIComponent(e.SPACE_ID),r=encodeURIComponent(e.ENVIRONMENT),s=encodeURIComponent(t),n=`https://api.contentful.com/spaces/${o}/environments/${r}/entries?content_type=${s}&limit=100`,a={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let i=await p(n,a,d);if(!i.ok)throw i.status===401||i.status===403?new Error("Invalid API credentials"):i.status===404?new Error("Content type not found"):new Error("Failed to fetch records");let l=await i.json();if(!l.items||!Array.isArray(l.items))throw new Error("Invalid response format");return l.items}catch(i){throw i instanceof Error?new Error(`Failed to load records: ${i.message}`):i}}async function D(e){let t=encodeURIComponent(e.SPACE_ID),o=encodeURIComponent(e.ENVIRONMENT),r=encodeURIComponent(e.CONTENT_TYPE),s=`https://api.contentful.com/spaces/${t}/environments/${o}/content_types/${r}`,n={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let a=await p(s,n,d);if(!a.ok)return a.status===404?{success:!1,error:"Content type not found"}:{success:!1,error:"Content type check failed"};let i=await a.json(),c=(Array.isArray(i.fields)?i.fields:[]).map(f=>f&&typeof f.id=="string"?f.id:"");return c.includes(e.KEY_FIELD)?c.includes(e.VALUE_FIELD)?{success:!0}:{success:!1,error:"Value field not found in content type"}:{success:!1,error:"Key field not found in content type"}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Content type check failed"}}}async function U(e){let t=encodeURIComponent(e.SPACE_ID),o=encodeURIComponent(e.ENVIRONMENT),r=encodeURIComponent(e.CONTENT_TYPE),s=1e3,n={headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}};try{let a=`https://api.contentful.com/spaces/${t}/environments/${o}/entries?content_type=${r}&limit=${s}`,i=await p(a,n,d);if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);let l=await i.json(),c=l.total||0,f=[l];if(c>s){let m=Math.ceil((c-s)/s),u=[];for(let g=1;g<=m;g++){let y=g*s,E=`https://api.contentful.com/spaces/${t}/environments/${o}/entries?content_type=${r}&limit=${s}&skip=${y}`;u.push(p(E,n,d).then(h=>h.json()).catch(h=>(console.error(`Failed to fetch page ${g}:`,h),{items:[]})))}let N=await Promise.all(u);f.push(...N)}let T={};for(let m of f)if(m.items&&Array.isArray(m.items))for(let u of m.items){if(u.sys.archivedVersion!==void 0)continue;let N=u.fields||{},g=N[e.KEY_FIELD],y=N[e.VALUE_FIELD],E=null,h=null;g&&typeof g=="object"&&(E=g["en-US"]||g[Object.keys(g)[0]]),y&&typeof y=="object"&&(h=y["en-US"]||y[Object.keys(y)[0]]),E&&h&&(T[E]={value:h,id:u.sys.id})}return T}catch(a){throw a instanceof Error?new Error(`Failed to fetch Contentful items: ${a.message}`):a}}async function b(e,t){let o=encodeURIComponent(e.SPACE_ID),r=encodeURIComponent(e.ENVIRONMENT),s=e.CONTENT_TYPE;try{if(t.isUpdate&&t.entryId){let n=`https://api.contentful.com/spaces/${o}/environments/${r}/entries/${t.entryId}`,a=await p(n,{headers:{Authorization:`Bearer ${e.CMA_TOKEN}`}},d);if(!a.ok){let u=await a.text();return console.error("[Contentful] Failed to fetch entry for update:",u),{success:!1,error:`Could not fetch entry (${a.status})`,errorDetails:{status:a.status,response:u,operation:"fetch",entryId:t.entryId}}}let l=(await a.json()).sys.version,c=await p(n,{method:"PUT",headers:{Authorization:`Bearer ${e.CMA_TOKEN}`,"Content-Type":"application/vnd.contentful.management.v1+json","X-Contentful-Version":l.toString()},body:JSON.stringify({fields:{[e.KEY_FIELD]:{"en-US":t.key},[e.VALUE_FIELD]:{"en-US":t.value}}})},d);if(!c.ok){let u=await c.text();return console.error("[Contentful] Update failed:",u),{success:!1,error:`Update failed (${c.status})`,errorDetails:{status:c.status,response:u,operation:"update",entryId:t.entryId,version:l}}}let f=await c.json(),T=`${n}/published`,m=await p(T,{method:"PUT",headers:{Authorization:`Bearer ${e.CMA_TOKEN}`,"X-Contentful-Version":f.sys.version.toString()}},d);if(!m.ok){let u=await m.text();return console.error("[Contentful] Publish failed:",u),{success:!1,error:`Publish failed (${m.status})`,errorDetails:{status:m.status,response:u,operation:"publish",entryId:t.entryId}}}return{success:!0}}else{let n=`https://api.contentful.com/spaces/${o}/environments/${r}/entries`,a=await p(n,{method:"POST",headers:{Authorization:`Bearer ${e.CMA_TOKEN}`,"Content-Type":"application/vnd.contentful.management.v1+json","X-Contentful-Content-Type":s},body:JSON.stringify({fields:{[e.KEY_FIELD]:{"en-US":t.key},[e.VALUE_FIELD]:{"en-US":t.value}}})},d);if(!a.ok){let f=await a.text();return console.error("[Contentful] Create failed:",f),{success:!1,error:`Create failed (${a.status})`,errorDetails:{status:a.status,response:f,operation:"create",key:t.key}}}let i=await a.json(),l=`https://api.contentful.com/spaces/${o}/environments/${r}/entries/${i.sys.id}/published`,c=await p(l,{method:"PUT",headers:{Authorization:`Bearer ${e.CMA_TOKEN}`,"X-Contentful-Version":i.sys.version.toString()}},d);if(!c.ok){let f=await c.text();return console.error("[Contentful] Publish after create failed:",f),{success:!1,error:`Created but publish failed (${c.status})`,errorDetails:{status:c.status,response:f,operation:"publish-new",entryId:i.sys.id}}}return{success:!0}}}catch(n){return console.error("[Contentful] Exception:",n),n instanceof Error?{success:!1,error:n.message,errorDetails:{exception:n.name,stack:n.stack,operation:t.isUpdate?"update":"create"}}:{success:!1,error:"Unknown error occurred",errorDetails:{exception:String(n)}}}}function v(e){try{if(!figma.currentPage)return 0;let t=new RegExp(e.NODE_NAME_PATTERN);return figma.currentPage.findAllWithCriteria({types:["TEXT"]}).filter(s=>s.name&&t.test(s.name)).length}catch(t){return console.error("Error counting translatable nodes:",t),0}}function O(){return figma.currentPage.findAllWithCriteria({types:["TEXT"]}).map(t=>({id:t.id,name:t.name,characters:t.characters}))}function L(e){let t=new RegExp(e.NODE_NAME_PATTERN);return figma.currentPage.findAll(r=>r.type==="TEXT"&&t.test(r.name)).map(r=>({id:r.id,name:r.name,characters:r.characters}))}async function V(e,t){let o=[];for(let r of e)try{let s=await figma.getNodeByIdAsync(r.node);if(!s||s.type!=="TEXT"){o.push(`Node not found: ${r.node}`);continue}if(s.locked){o.push(`Node is locked: ${s.name}`);continue}let n=t[r.field];if(n==null)continue;let a=String(n);if(s.hasMissingFont){o.push(`Missing font in node: ${s.name}`);continue}let i=s.fontName;if(i===figma.mixed){let l=new Set;for(let c=0;c<s.characters.length;c++){let f=s.getRangeFontName(c,c+1);l.add(`${f.family}:${f.style}`),await figma.loadFontAsync(f)}}else await figma.loadFontAsync(i);s.characters=a}catch(s){let n=s instanceof Error?s.message:"Unknown error";o.push(`Error applying to node: ${n}`)}o.length>0&&console.warn("Some mappings failed:",o)}async function K(e,t){if(!e||!Array.isArray(e)||e.length===0)return{success:!1,count:0,error:"Invalid node IDs"};let o=0,r=[];for(let s of e)try{let n=await figma.getNodeByIdAsync(s);if(!n||!("type"in n)||n.type!=="TEXT"){r.push(`Node ${s}: Not found or not a text node`);continue}let a=n;if(a.hasMissingFont){r.push(`${n.name}: Missing font`);continue}let i=a.fontName;if(i===figma.mixed)for(let l=0;l<a.characters.length;l++){let c=a.getRangeFontName(l,l+1);await figma.loadFontAsync(c)}else await figma.loadFontAsync(i);a.characters=t,o++}catch(n){let a=n instanceof Error?n.message:String(n);r.push(`Node ${s}: ${a}`)}return{success:o>0,count:o,errors:r.length>0?r:void 0,error:o===0?r[0]:void 0}}async function z(e){try{let t=await figma.getNodeByIdAsync(e);t&&"type"in t&&(figma.currentPage.selection=[t],figma.viewport.scrollAndZoomIntoView([t]))}catch(t){console.error("Error selecting node:",t)}}async function j(){let e=await I();if(figma.ui.postMessage({type:"config-loaded",config:e,version:R}),!M(e)){let o=v(e);figma.ui.postMessage({type:"node-count",count:o})}}function Y(e){e()}async function B(e){if(!e){figma.ui.postMessage({type:"config-save-failed",message:"No config provided"});return}let t=M(e);if(t){figma.ui.postMessage({type:"config-save-failed",message:t});return}await $(e),figma.ui.postMessage({type:"config-saved",config:e});let o=v(e);figma.ui.postMessage({type:"node-count",count:o})}async function q(e){if(!e){figma.ui.postMessage({type:"preflight-locales-result",result:{success:!1,error:"No config provided"}});return}try{let t=await k(e);if(t.length===0)throw new Error("No locales found");figma.ui.postMessage({type:"preflight-locales-result",result:{success:!0,message:`Found ${t.length} locale(s)`}})}catch(t){let o=t instanceof Error?t.message:"Failed to fetch locales";figma.ui.postMessage({type:"preflight-locales-result",result:{success:!1,error:o}})}}async function X(e){if(!e){figma.ui.postMessage({type:"preflight-content-result",result:{success:!1,error:"No config provided"}});return}let t=await D(e);t.success?figma.ui.postMessage({type:"preflight-content-result",result:{success:!0,message:"Content type validated"}}):figma.ui.postMessage({type:"preflight-content-result",result:{success:!1,error:t.error}})}async function G(e){if(!e){figma.ui.postMessage({type:"error",message:"Configuration missing"});return}try{let t=await F(e);figma.ui.postMessage({type:"content-types-loaded",contentTypes:t})}catch(t){let o=t instanceof Error?t.message:String(t);figma.ui.postMessage({type:"error",message:o})}}function W(){try{let e=O();figma.ui.postMessage({type:"text-nodes-loaded",nodes:e})}catch(e){let t=e instanceof Error?e.message:String(e);figma.ui.postMessage({type:"error",message:t})}}async function H(e,t){if(!e||!t){figma.ui.postMessage({type:"error",message:"Configuration or content type missing"});return}try{let o=await A(e,t);figma.ui.postMessage({type:"records-loaded",records:o})}catch(o){let r=o instanceof Error?o.message:String(o);figma.ui.postMessage({type:"error",message:r})}}async function J(e,t){if(!e||!t){figma.ui.postMessage({type:"error",message:"Configuration or content types missing"});return}try{let o={};for(let r of t){let s=await A(e,r);o[r]=s}figma.ui.postMessage({type:"multiple-records-loaded",recordsByContentType:o})}catch(o){let r=o instanceof Error?o.message:String(o);figma.ui.postMessage({type:"error",message:r})}}async function Z(e,t){if(!e||!t){figma.ui.postMessage({type:"error",message:"Mappings or record data missing"});return}try{await V(e,t),figma.ui.postMessage({type:"record-applied"})}catch(o){let r=o instanceof Error?o.message:String(o);figma.ui.postMessage({type:"error",message:r})}}function Q(e){if(!e){figma.ui.postMessage({type:"error",message:"Configuration missing"});return}try{let t=L(e);figma.ui.postMessage({type:"translatable-nodes-loaded",nodes:t})}catch(t){let o=t instanceof Error?t.message:String(t);figma.ui.postMessage({type:"error",message:o})}}async function ee(e){if(!e){figma.ui.postMessage({type:"error",message:"Configuration missing"});return}try{let t=await U(e);figma.ui.postMessage({type:"contentful-items-loaded",items:t})}catch(t){let o=t instanceof Error?t.message:String(t);figma.ui.postMessage({type:"error",message:o})}}async function te(e,t){if(!e||!t){figma.ui.postMessage({type:"error",message:"Configuration or item missing"});return}try{let o=t,r=await b(e,o);figma.ui.postMessage({type:"item-saved",key:o.key,success:r.success,error:r.error,errorDetails:r.errorDetails})}catch(o){let r=o instanceof Error?o.message:String(o),s=o instanceof Error?{exception:o.name,stack:o.stack}:{exception:String(o)},n=t;figma.ui.postMessage({type:"item-saved",key:n.key,success:!1,error:r,errorDetails:s})}}async function oe(){let e=await figma.clientStorage.getAsync("window-size-compact");figma.ui.postMessage({type:"window-size-state",isCompact:e||!1})}async function ne(e,t,o){if(e&&t)try{figma.ui.resize(e,t),o!==void 0&&await figma.clientStorage.setAsync("window-size-compact",o)}catch(r){console.error("Failed to resize window:",r)}else console.error("Invalid resize dimensions:",e,t)}async function re(e,t){if(!e||!Array.isArray(e)||e.length===0||t===void 0){figma.ui.postMessage({type:"update-multiple-nodes-result",success:!1,error:"Invalid node IDs or text"});return}let o=await K(e,t);figma.ui.postMessage({type:"update-multiple-nodes-result",success:o.success,count:o.count,errors:o.errors,error:o.error})}async function se(e){e&&await z(e)}function ae(){figma.closePlugin()}var ie=null,ce=0,he=200;function le(e){return async t=>{let o=Date.now(),r=o-ce;if(!((t==null?void 0:t.type)===ie&&r<he)){ie=t==null?void 0:t.type,ce=o;try{if(!t||typeof t!="object"||typeof t.type!="string"){console.error("Invalid message format:",t);return}switch(t.type){case"init":await j();break;case"plugin-ready":Y(e);break;case"save-config":await B(t.config);break;case"preflight-test-locales":await q(t.config);break;case"preflight-check-content":await X(t.config);break;case"load-content-types":await G(t.config);break;case"get-text-nodes":W();break;case"load-records":await H(t.config,t.contentType);break;case"load-multiple-records":await J(t.config,t.contentTypes);break;case"apply-record-to-nodes":await Z(t.mappings,t.recordFields);break;case"get-translatable-nodes":Q(t.config);break;case"get-all-contentful-items":await ee(t.config);break;case"save-contentful-item":await te(t.config,t.item);break;case"get-window-size-state":await oe();break;case"resize-window":await ne(t.width,t.height,t.isCompact);break;case"update-multiple-nodes":await re(t.nodeIds,t.newText);break;case"select-node":await se(t.nodeId);break;case"cancel":ae();break;default:console.warn("Unknown message type:",t.type)}}catch(s){console.error("Message handler error:",s);let n=s instanceof Error?s.message:String(s);try{figma.ui.postMessage({type:"error",message:n})}catch(a){console.error("Failed to send error to UI:",a)}}}}}figma.showUI(__html__,{width:800,height:500,themeColors:!0});(async()=>await figma.loadAllPagesAsync())();var fe=!1,x=null,ue=I();function Ee(){fe||(figma.on("selectionchange",()=>{x&&clearTimeout(x),x=setTimeout(async()=>{try{if(!figma.currentPage)return;let e=figma.currentPage.selection;if(e.length===1&&e[0]&&e[0].type==="TEXT"){let t=e[0],o=await ue;if(o&&o.NODE_NAME_PATTERN)try{if(!new RegExp(o.NODE_NAME_PATTERN).test(t.name))return}catch(s){console.warn("Invalid regex pattern in config:",s);return}let r="";try{r=t.characters}catch(s){console.warn("Could not read text node characters:",s),r="[Unable to read text]"}figma.ui.postMessage({type:"text-node-selected",nodeName:t.name||"[Unnamed]",nodeText:r})}}catch(e){console.error("Selection change handler error:",e)}},S)}),fe=!0)}var de=le(Ee);figma.ui.onmessage=de;figma.ui.onmessage=async e=>{await de(e),e.type==="save-config"&&e.config&&(ue=Promise.resolve(e.config))};})();
