<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  
  :root {
    /* 8-Step Color Scales - Perceptually Balanced */
    /* All colors at same step number have same luminance for visual consistency */

    /* Gray Scale */
    --gray-50: #fafafa;   /* ~95% luminance */
    --gray-100: #f5f5f5;  /* ~85% */
    --gray-200: #eeeeee;  /* ~75% */
    --gray-300: #e0e0e0;  /* ~65% */
    --gray-400: #bdbdbd;  /* ~55% */
    --gray-500: #9e9e9e;  /* ~50% */
    --gray-600: #757575;  /* ~40% */
    --gray-700: #616161;  /* ~30% */
    --gray-800: #424242;  /* ~20% */

    /* Blue Scale */
    --blue-50: #e3f2fd;   /* ~95% */
    --blue-100: #bbdefb;  /* ~85% */
    --blue-200: #90caf9;  /* ~75% */
    --blue-300: #64b5f6;  /* ~65% */
    --blue-400: #42a5f5;  /* ~55% */
    --blue-500: #2196f3;  /* ~50% - base */
    --blue-600: #1e88e5;  /* ~40% */
    --blue-700: #1976d2;  /* ~30% */
    --blue-800: #1565c0;  /* ~20% */

    /* Green Scale */
    --green-50: #e8f5e9;   /* ~95% */
    --green-100: #c8e6c9;  /* ~85% */
    --green-200: #a5d6a7;  /* ~75% */
    --green-300: #81c784;  /* ~65% */
    --green-400: #66bb6a;  /* ~55% */
    --green-500: #4caf50;  /* ~50% - base */
    --green-600: #43a047;  /* ~40% */
    --green-700: #388e3c;  /* ~30% */
    --green-800: #2e7d32;  /* ~20% */

    /* Yellow Scale */
    --yellow-50: #fffde7;  /* ~95% */
    --yellow-100: #fff9c4; /* ~85% */
    --yellow-200: #fff59d; /* ~75% */
    --yellow-300: #fff176; /* ~65% */
    --yellow-400: #ffee58; /* ~55% */
    --yellow-500: #ffeb3b; /* ~50% - base */
    --yellow-600: #fdd835; /* ~40% */
    --yellow-700: #fbc02d; /* ~30% */
    --yellow-800: #f9a825; /* ~20% */

    /* Orange Scale */
    --orange-50: #fff3e0;  /* ~95% */
    --orange-100: #ffe0b2; /* ~85% */
    --orange-200: #ffcc80; /* ~75% */
    --orange-300: #ffb74d; /* ~65% */
    --orange-400: #ffa726; /* ~55% */
    --orange-500: #ff9800; /* ~50% - base */
    --orange-600: #fb8c00; /* ~40% */
    --orange-700: #f57c00; /* ~30% */
    --orange-800: #ef6c00; /* ~20% */

    /* Red Scale */
    --red-50: #ffebee;     /* ~95% */
    --red-100: #ffcdd2;    /* ~85% */
    --red-200: #ef9a9a;    /* ~75% */
    --red-300: #e57373;    /* ~65% */
    --red-400: #ef5350;    /* ~55% */
    --red-500: #f44336;    /* ~50% - base */
    --red-600: #e53935;    /* ~40% */
    --red-700: #d32f2f;    /* ~30% */
    --red-800: #c62828;    /* ~20% */

    /* Pure Black & White (for absolute values) */
    --white: #ffffff;
    --black: #000000;

    /* Semantic Aliases - map to color scales */
    --figma-bg: var(--white);
    --figma-bg-secondary: var(--gray-50);

    --figma-border: var(--gray-300);
    --figma-border-secondary: var(--gray-500);

    --figma-text: var(--gray-800);
    --figma-text-secondary: var(--gray-600);
    --figma-text-tertiary: var(--gray-500);


    --figma-accent: var(--yellow-600);
    --figma-accent-hover: var(--yellow-700);
    --figma-danger: var(--red-500);
    --figma-success: var(--green-500);

    --figma-blue: var(--blue-500);
    --figma-blue-hover: var(--blue-700);

    /* Link Colors - use blue scale */
    --figma-link: var(--blue-700);
    --figma-link-hover: var(--blue-800);

    /* Special Use */
    --figma-hover-overlay: rgba(0, 0, 0, 0.04);
    --figma-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  /* Dark theme */
  body.figma-dark {
    /* In dark mode, grays invert (lightest becomes darkest) */
    --gray-50: #1e1e1e;
    --gray-100: #2c2c2c;
    --gray-200: #3c3c3c;
    --gray-300: #4a4a4a;
    --gray-400: #666666;
    --gray-500: #999999;
    --gray-600: #cccccc;
    --gray-700: #e5e5e5;
    --gray-800: #ffffff;

    /* Background switches to dark gray in dark mode */
    --figma-bg: var(--gray-100);

    /* Dark mode specific overrides */
    --figma-hover-overlay: rgba(255, 255, 255, 0.06);
    --figma-icon-bg: rgba(255, 255, 255, 0.1);
    --figma-icon-bg-hover: rgba(255, 255, 255, 0.2);
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  @keyframes slideIn {
    from { transform: translateX(-100%); }
    to { transform: translateX(0); }
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  @keyframes success {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    padding: 0;
    background: var(--figma-bg);
    color: var(--figma-text);
    height: 100vh;
    overflow: hidden;
    transition: background 0.3s ease, color 0.3s ease;
  }
  
  .container {
    animation: fadeIn 0.4s ease-out;
  }
  
  h2 {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--figma-text);
    text-align: center;
    letter-spacing: -0.5px;
  }
  
  .subtitle {
    text-align: center;
    font-size: 11px;
    color: var(--figma-text-tertiary);
    margin-bottom: 16px;
  }
  
  .section {
    background: var(--figma-bg);
    border-radius: 0;
    padding: 12px 16px;
    margin-bottom: 0;
    border-bottom: 1px solid var(--figma-border);
    transition: background 0.2s ease;
  }
  
  body.figma-dark .section {
    background: rgba(30, 30, 30, 0.85);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .stats {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }
  
  .stat-card {
    flex: 1;
    background: var(--figma-bg-secondary);
    border: 1px solid var(--figma-border);
    color: var(--figma-text);
    padding: 12px;
    border-radius: 6px;
    text-align: center;
  }
  
  .stat-number {
    font-size: 24px;
    font-weight: 700;
    display: block;
    margin-bottom: 4px;
  }
  
  .stat-label {
    font-size: 10px;
    color: var(--figma-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--figma-text-secondary);
    transition: color 0.3s ease;
  }
  
  select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--figma-border);
    border-radius: 4px;
    font-size: 13px;
    background: var(--figma-bg-secondary);
    color: var(--figma-text);
    transition: all 0.2s;
    cursor: pointer;
  }
  
  select:focus {
    outline: none;
    border-color: #18a0fb;
    box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.2);
  }
  
  select:disabled {
    background: var(--figma-bg);
    cursor: not-allowed;
    opacity: 0.6;
  }
  
  button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s ease;
  }
  
  button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  
  .button-group {
    display: flex;
    gap: 8px;
  }
  
  #apply-translation {
    background: #18a0fb;
    color: white;
    flex: 1;
  }
  
  #apply-translation:hover:not(:disabled) {
    background: #0d8de0;
  }
  
  #cancel {
    background: var(--figma-bg);
    color: var(--figma-text-tertiary);
    flex: 0 0 auto;
    padding: 10px 16px;
    transition: all 0.3s ease;
  }
  
  #cancel:hover {
    background: var(--figma-border);
  }
  
  .status-container {
    position: relative;
    min-height: 0;
  }
  
  #status {
    padding: 12px 16px;
    font-size: 13px;
    border-radius: 0;
    margin-bottom: 0;
    animation: slideIn 0.3s ease-out;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid var(--figma-border);
  }
  
  #status.info {
    background: var(--figma-bg);
    color: var(--figma-text-secondary);
    border-left: none;
  }
  
  #status.success {
    background: var(--figma-bg);
    color: var(--figma-success);
    border-left: none;
    animation: success 0.4s ease-out;
  }
  
  #status.error {
    background: var(--figma-bg);
    color: var(--figma-danger);
    border-left: none;
  }
  
  #status.loading {
    background: var(--figma-bg);
    color: var(--figma-text-secondary);
    border-left: none;
  }
  
  #status:empty {
    display: none;
  }
  
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(0,0,0,0.1);
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  
  .hidden {
    display: none !important;
  }
  
  .locale-option {
    padding: 8px;
  }
  
  .refresh-icon {
    display: inline-block;
    transition: transform 0.3s;
  }
  
  button:hover .refresh-icon {
    transform: rotate(180deg);
  }
  
  /* Settings Screen */
  .view {
    display: none;
  }
  
  .view.active {
    display: flex !important;
  }
  
  .container {
    max-height: 100vh;
  }
  
  .btn-icon {
    background: var(--figma-bg);
    color: var(--figma-text-secondary);
    border: 1px solid var(--figma-border);
    border-radius: 4px;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 32px;
    min-height: 32px;
  }
  
  .btn-icon:hover {
    background: var(--figma-bg-secondary);
    border-color: var(--figma-text-tertiary);
    color: var(--figma-text);
  }
  
  .btn-icon:active {
    transform: scale(0.95);
  }
  
  .btn-icon svg {
    display: block;
  }
  
  textarea {
    width: 100%;
    min-height: 200px;
    padding: 12px;
    border: 2px solid var(--figma-border);
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    resize: vertical;
    background: var(--figma-bg);
    color: var(--figma-text);
    transition: all 0.3s ease;
  }
  
  textarea:focus {
    outline: none;
    border-color: #18a0fb;
    box-shadow: 0 0 0 2px rgba(24, 160, 251, 0.2);
  }
  
  .config-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  
  .btn-primary {
    background: var(--figma-accent);
    color: #1a1a1a;
    font-weight: 600;
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--figma-accent-hover);
  }
  
  .btn-secondary {
    background: var(--figma-bg);
    color: var(--figma-text);
    border: 1px solid var(--figma-border);
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .btn-secondary:hover:not(:disabled) {
    background: var(--figma-bg-secondary);
  }
  
  .btn-test {
    background: #18a0fb;
    color: white;
  }

  input[type="text"],
  input[type="password"] {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--figma-border);
    border-radius: 4px;
    font-size: 13px;
    background: var(--figma-bg);
    color: var(--figma-text);
    transition: border-color 0.2s ease;
  }
  
  input[type="text"]:focus,
  input[type="password"]:focus {
    outline: none;
    border-color: var(--figma-accent);
  }
  
  input[type="text"]::placeholder,
  input[type="password"]::placeholder {
    color: var(--figma-text-tertiary);
  }

  input[type="password"] {
    font-family: 'Courier New', monospace;
    letter-spacing: 2px;
  }

  .config-field {
    margin-bottom: 16px;
  }

  .config-field label {
    display: block;
    margin-bottom: 6px;
  }

  .preflight-container {
    background: var(--figma-bg);
    border-radius: 8px;
    padding: 16px;
    margin-top: 12px;
    display: none;
    transition: background 0.3s ease;
  }

  .preflight-container.active {
    display: block;
  }

  .preflight-step {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    margin-bottom: 8px;
    background: var(--figma-bg-secondary);
    border-radius: 6px;
    border: 2px solid var(--figma-border);
    transition: all 0.3s ease;
    min-height: 44px;
  }

  .preflight-step.checking {
    border-color: var(--blue-500);
    background: var(--figma-bg-secondary);
  }

  .preflight-step.success {
    border-color: var(--green-600);
    background: var(--figma-bg-secondary);
  }

  .preflight-step.error {
    border-color: var(--red-600);
    background: var(--figma-bg-secondary);
  }

  .preflight-icon {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .preflight-icon svg {
    width: 20px;
    height: 20px;
    transition: all 0.2s ease;
  }

  .preflight-icon .spinner {
    animation: spin 0.8s linear infinite;
  }

  .preflight-text {
    flex: 1;
    font-size: 13px;
    color: var(--figma-text-secondary);
    transition: color 0.3s ease;
  }

  /* Mode Toggle */
  .mode-toggle {
    display: flex;
    gap: 8px;
    padding: 12px 16px 0;
    background: transparent;
  }

  .mode-btn {
    flex: 1;
    padding: 10px;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid transparent;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mode-btn:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .mode-btn.active {
    background: white;
    color: var(--figma-gradient-1);
    border-color: white;
  }

  /* Content Preview Styles */
  .mapping-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .btn-small {
    padding: 6px 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-small:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
  }

  .mapping-item {
    background: var(--figma-bg);
    border: 2px solid var(--figma-border);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 8px;
    transition: all 0.2s;
  }

  .mapping-item:hover {
    border-color: var(--figma-gradient-1);
  }

  .mapping-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
  }

  .mapping-row:last-child {
    margin-bottom: 0;
  }

  .mapping-row select {
    flex: 1;
    padding: 8px;
    font-size: 12px;
  }

  .mapping-row label {
    font-size: 11px;
    margin-bottom: 4px;
    color: var(--figma-text-tertiary);
  }

  .mapping-field {
    flex: 1;
  }

  .btn-remove {
    padding: 8px 12px;
    background: #ff5252;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-remove:hover {
    background: #ff1744;
    transform: translateY(-1px);
  }

  .record-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .record-info {
    font-size: 12px;
    color: var(--figma-text-tertiary);
    font-weight: 600;
  }

  .record-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .btn-nav {
    flex: 1;
    padding: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-nav:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .btn-nav:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .contentful-link {
    color: #0066CC;
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: color 0.2s ease;
  }
  
  .contentful-link:hover {
    color: #0052A3;
    text-decoration: underline;
  }
  
  .contentful-link::after {
    content: '↗';
    font-size: 10px;
    opacity: 0.5;
  }
  
  .record-data {
    background: var(--figma-bg);
    border-radius: 8px;
    padding: 12px;
    max-height: 200px;
    overflow-y: auto;
  }

  .record-field {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    margin-bottom: 6px;
    background: var(--figma-bg-secondary);
    border-radius: 6px;
    font-size: 12px;
  }

  .record-field:last-child {
    margin-bottom: 0;
  }

  .field-name {
    font-weight: 600;
    color: var(--figma-text-secondary);
  }

  .field-value {
    color: var(--figma-text-tertiary);
    max-width: 60%;
    text-align: right;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, #00c853 0%, #00a844 100%);
    color: white;
    flex: 1;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 200, 83, 0.4);
  }

  .content-type-badge {
    display: inline-block;
    background: var(--figma-gradient-1);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .content-type-group {
    background: var(--figma-bg);
    border: 2px solid var(--figma-gradient-1);
    border-radius: 10px;
    padding: 14px;
    margin-bottom: 12px;
    animation: fadeIn 0.3s ease-out;
  }

  .content-type-group-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 2px solid var(--figma-border);
  }

  .content-type-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    color: var(--figma-text-secondary);
  }

  .btn-remove-group {
    padding: 6px 10px;
    background: #ff5252;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-remove-group:hover {
    background: #ff1744;
    transform: translateY(-1px);
  }

  .add-field-btn {
    width: 100%;
    margin-top: 8px;
    padding: 8px;
    background: transparent;
    border: 2px dashed var(--figma-border);
    color: var(--figma-text-tertiary);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .add-field-btn:hover {
    border-color: var(--figma-gradient-1);
    color: var(--figma-gradient-1);
    background: rgba(102, 126, 234, 0.05);
  }

  /* Write Mode Styles */
  .write-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0;
    font-size: 13px;
  }

  .write-table th {
    background: var(--figma-bg-secondary);
    color: var(--figma-text-secondary);
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    border-bottom: 1px solid var(--figma-border);
    position: sticky;
    top: 0;
    z-index: 1;
    text-transform: none;
  }

  .write-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--figma-border);
    vertical-align: middle;
    font-size: 13px;
    color: var(--figma-text);
  }

  .write-table tbody tr:hover {
    background: var(--figma-bg-secondary);
  }

  .write-table tbody tr {
    transition: background 0.15s ease;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .status-badge.not-exists {
    background: #FFF9E6;
    color: #F59E0B;
    border: 1px solid #FDE68A;
  }

  .status-badge.out-of-sync {
    background: #FEE2E2;
    color: #DC2626;
    border: 1px solid #FECACA;
  }

  .status-badge.synced {
    background: #D1FAE5;
    color: #059669;
    border: 1px solid #A7F3D0;
  }

  .status-badge.checking {
    background: var(--figma-bg-secondary);
    color: var(--figma-text-tertiary);
    border: 1px solid var(--figma-border);
  }

  /* Error Modal */
  .error-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }

  .error-modal.show {
    display: flex;
  }

  .error-modal-content {
    background: var(--figma-bg);
    border-radius: 8px;
    padding: 20px;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }

  .error-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--figma-border);
  }

  .error-modal-title {
    font-size: 16px;
    font-weight: 600;
    color: #f44336;
  }

  .error-modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--figma-text);
    padding: 0;
    width: 24px;
    height: 24px;
  }

  .error-modal-close:hover {
    opacity: 0.7;
  }

  .error-modal-body {
    margin-bottom: 16px;
  }

  .error-message {
    font-size: 14px;
    color: var(--figma-text);
    margin-bottom: 12px;
    line-height: 1.5;
  }

  .error-details {
    background: var(--figma-bg-secondary);
    border: 1px solid var(--figma-border);
    border-radius: 4px;
    padding: 12px;
    font-family: 'Courier New', monospace;
    font-size: 11px;
    color: var(--figma-text-secondary);
    overflow-x: auto;
    max-height: 200px;
  }

  .error-modal-footer {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .btn-copy-error {
    background: var(--figma-bg-secondary);
    color: var(--figma-text);
    border: 1px solid var(--figma-border);
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }

  .btn-copy-error:hover {
    background: var(--figma-hover-overlay);
  }

  .btn-close-modal {
    background: #0d99ff;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
  }

  .btn-close-modal:hover {
    background: #0b7fd4;
  }

  .btn-save-item {
    padding: 6px 16px;
    background: var(--figma-accent);
    color: #1a1a1a;
    border: none;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-save-item:hover {
    background: var(--figma-accent-hover);
  }

  .btn-save-item:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .table-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    border: none;
    border-radius: 0;
    background: var(--figma-bg);
    min-height: 0;
    max-height: 100%;
  }
  
  body.figma-dark .table-container {
    background: #2c2c2c;
    border: none;
  }

  .mode-switch {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .mode-switch-btn {
    flex: 1;
    padding: 10px;
    background: var(--figma-bg);
    color: var(--figma-text);
    border: 2px solid var(--figma-border);
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .mode-switch-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
  }

  .mode-switch-btn:hover:not(.active) {
    border-color: var(--figma-gradient-1);
    background: rgba(102, 126, 234, 0.05);
  }

  .text-preview {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Write Status Footer */
  #write-status {
    padding: 10px 16px;
    font-size: 12px;
    color: var(--figma-text-secondary);
    background: var(--figma-bg-secondary);
    border-top: 1px solid var(--figma-border);
    display: flex;
    align-items: center;
    gap: 6px;
    min-height: 36px;
  }

  #write-status:empty {
    display: none;
  }

  #write-status.success {
    color: var(--figma-success);
  }

  #write-status.error {
    color: var(--figma-danger);
  }

  #write-status.loading {
    color: var(--figma-text-secondary);
  }

  #write-status::before {
    content: '';
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
    opacity: 0.6;
  }

  #write-status.success::before {
    background: var(--figma-success);
    opacity: 1;
  }

  #write-status.error::before {
    background: var(--figma-danger);
    opacity: 1;
  }

  #write-status.loading::before {
    animation: pulse 1.5s ease-in-out infinite;
  }

  /* Reset Confirmation Modal */
  .reset-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }

  .reset-modal.show {
    display: flex;
  }

  .reset-modal-content {
    background: var(--figma-bg);
    border-radius: 8px;
    padding: 20px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
  }

  .reset-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .reset-modal-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--figma-text);
  }

  .reset-modal-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: var(--figma-text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .reset-modal-close:hover {
    color: var(--figma-text);
  }

  .reset-modal-body {
    margin-bottom: 20px;
    color: var(--figma-text);
    font-size: 13px;
    line-height: 1.5;
  }

  .reset-modal-footer {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }

  .btn-danger {
    background: var(--red-500);
    color: var(--white);
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
  }

  .btn-danger:hover {
    background: var(--red-600);
  }

  /* Validation Modal */
  .validation-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }

  .validation-modal.show {
    display: flex;
  }

  .validation-modal-content {
    background: var(--figma-bg);
    border-radius: 8px;
    padding: 20px;
    max-width: 500px;
    width: 90%;
    max-height: 600px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
  }

  .validation-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    flex-shrink: 0;
  }

  .validation-modal-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--figma-text);
  }

  .validation-modal-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: var(--figma-text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .validation-modal-close:hover {
    color: var(--figma-text);
  }

  .validation-modal-body {
    color: var(--figma-text);
    font-size: 13px;
    line-height: 1.5;
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
    min-height: 0;
    padding-right: 4px;
  }

  .validation-modal-body::-webkit-scrollbar {
    width: 8px;
  }

  .validation-modal-body::-webkit-scrollbar-track {
    background: transparent;
  }

  .validation-modal-body::-webkit-scrollbar-thumb {
    background: var(--figma-border);
    border-radius: 4px;
  }

  .validation-modal-body::-webkit-scrollbar-thumb:hover {
    background: var(--figma-border-secondary);
  }

  #validation-steps-container {
    display: flex;
    flex-direction: column;
  }

  #validation-steps-container .preflight-step:last-child {
    margin-bottom: 0;
  }

  .validation-modal-footer {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 16px;
    flex-shrink: 0;
  }
</style>

<!-- Write Mode View (Default) -->
<div class="container view active" id="write-view" style="height: 100vh; display: flex; flex-direction: column;">
  <div class="section" style="padding: 12px 16px; display: flex; align-items: center; gap: 8px;">
    <button class="btn-icon" id="btn-load-items" title="Sync keys">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M13.65 2.35C12.2 0.9 10.21 0 8 0C3.58 0 0.01 3.58 0.01 8C0.01 12.42 3.58 16 8 16C11.73 16 14.84 13.45 15.73 10H13.65C12.83 12.33 10.61 14 8 14C4.69 14 2 11.31 2 8C2 4.69 4.69 2 8 2C9.66 2 11.14 2.69 12.22 3.78L9 7H16V0L13.65 2.35Z" fill="currentColor"/>
      </svg>
    </button>
    <input type="text" id="search-input" placeholder="Search keys or text..." 
           style="flex: 1; padding: 8px 12px; border: 1px solid var(--figma-border); border-radius: 4px; font-size: 13px; background: var(--figma-bg-secondary); color: var(--figma-text); box-sizing: border-box;" />
    <button class="btn-icon" id="settings-toggle-inline" title="Settings">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M13.5 8C13.5 8.17 13.49 8.34 13.47 8.51L15.04 9.7C15.18 9.81 15.22 10.01 15.13 10.17L13.63 12.83C13.54 12.99 13.35 13.05 13.18 12.99L11.34 12.27C10.97 12.55 10.56 12.78 10.12 12.95L9.84 14.91C9.82 15.09 9.66 15.22 9.47 15.22H6.47C6.28 15.22 6.12 15.09 6.1 14.91L5.82 12.95C5.38 12.78 4.97 12.55 4.6 12.27L2.76 12.99C2.59 13.05 2.4 12.99 2.31 12.83L0.81 10.17C0.72 10.01 0.76 9.81 0.9 9.7L2.47 8.51C2.45 8.34 2.44 8.17 2.44 8C2.44 7.83 2.45 7.66 2.47 7.49L0.9 6.3C0.76 6.19 0.72 5.99 0.81 5.83L2.31 3.17C2.4 3.01 2.59 2.95 2.76 3.01L4.6 3.73C4.97 3.45 5.38 3.22 5.82 3.05L6.1 1.09C6.12 0.91 6.28 0.78 6.47 0.78H9.47C9.66 0.78 9.82 0.91 9.84 1.09L10.12 3.05C10.56 3.22 10.97 3.45 11.34 3.73L13.18 3.01C13.35 2.95 13.54 3.01 13.63 3.17L15.13 5.83C15.22 5.99 15.18 6.19 15.04 6.3L13.47 7.49C13.49 7.66 13.5 7.83 13.5 8ZM8 5.5C6.62 5.5 5.5 6.62 5.5 8C5.5 9.38 6.62 10.5 8 10.5C9.38 10.5 10.5 9.38 10.5 8C10.5 6.62 9.38 5.5 8 5.5Z" fill="currentColor"/>
      </svg>
    </button>
</div>

  <div class="section hidden" id="items-table-section" style="padding: 6px; flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
    <div class="table-container">
      <table class="write-table">
        <thead>
          <tr>
            <th>Key</th>
            <th>Text</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="items-table-body">
          <!-- Items will be loaded here -->
        </tbody>
      </table>
    </div>
</div>

  <div class="status-container">
    <div id="write-status"></div>
  </div>
</div>

<!-- Read Mode View -->
<div class="container view" id="read-view">
  <h2>
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">
      <path d="M10 0L12.245 6.90983L19.5106 6.90983L13.6328 11.1803L15.8779 18.0902L10 13.8197L4.12215 18.0902L6.36729 11.1803L0.489435 6.90983L7.755 6.90983L10 0Z" fill="currentColor"/>
    </svg>
    ConteFi
  </h2>
  <div class="subtitle">Contentful-powered translation magic</div>

  <div class="stats">
    <div class="stat-card">
      <span class="stat-number" id="node-count">-</span>
      <span class="stat-label">Text Nodes</span>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="locale-count">-</span>
      <span class="stat-label">Languages</span>
    </div>
  </div>

  <div class="section">
    <label>
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">
        <path d="M7 0C3.13401 0 0 3.13401 0 7C0 10.866 3.13401 14 7 14C10.866 14 14 10.866 14 7C14 3.13401 10.866 0 7 0ZM11.5513 4.2H9.60315C9.36519 3.21207 8.99645 2.27614 8.51367 1.43004C9.89895 1.87982 11.0315 2.88889 11.5513 4.2ZM7 1.4245C7.63492 2.33333 8.12188 3.33403 8.4224 4.2H5.5776C5.87812 3.33403 6.36508 2.33333 7 1.4245ZM1.53242 8.4C1.43403 8.01287 1.4 7.61736 1.4 7C1.4 6.38264 1.43403 5.98713 1.53242 5.6H3.80091C3.75849 5.99551 3.73333 6.39102 3.73333 7C3.73333 7.60898 3.75849 8.00449 3.80091 8.4H1.53242ZM2.44869 9.8H4.39685C4.63481 10.7879 5.00355 11.7239 5.48633 12.57C4.10105 12.1202 2.96849 11.1111 2.44869 9.8ZM4.39685 4.2H2.44869C2.96849 2.88889 4.10105 1.87982 5.48633 1.43004C5.00355 2.27614 4.63481 3.21207 4.39685 4.2ZM7 12.5755C6.36508 11.6667 5.87812 10.666 5.5776 9.8H8.4224C8.12188 10.666 7.63492 11.6667 7 12.5755ZM8.6968 8.4H5.3032C5.25239 8.00449 5.23333 7.60898 5.23333 7C5.23333 6.39102 5.25239 5.99551 5.3032 5.6H8.6968C8.74761 5.99551 8.76667 6.39102 8.76667 7C8.76667 7.60898 8.74761 8.00449 8.6968 8.4ZM8.51367 12.57C8.99645 11.7239 9.36519 10.7879 9.60315 9.8H11.5513C11.0315 11.1111 9.89895 12.1202 8.51367 12.57ZM10.1991 8.4C10.2415 8.00449 10.2667 7.60898 10.2667 7C10.2667 6.39102 10.2415 5.99551 10.1991 5.6H12.4676C12.566 5.98713 12.6 6.38264 12.6 7C12.6 7.61736 12.566 8.01287 12.4676 8.4H10.1991Z" fill="currentColor"/>
      </svg>
      Select Language
    </label>
    <select id="locale" disabled>
      <option value="">Loading locales...</option>
    </select>
  </div>

  <div class="section">
    <div class="button-group">
      <button id="apply-translation" disabled>
        <span>Apply Translation</span>
      </button>
      <button id="cancel">Close</button>
    </div>
  </div>

  <div class="status-container">
    <div id="status"></div>
  </div>
</div>

<!-- Content Preview View -->
<div class="container view" id="preview-view">
  <h2>
    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">
      <path d="M15 0H3C1.34315 0 0 1.34315 0 3V15C0 16.6569 1.34315 18 3 18H15C16.6569 18 18 16.6569 18 15V3C18 1.34315 16.6569 0 15 0Z" fill="currentColor" opacity="0.2"/>
      <path d="M4.5 4.5H13.5M4.5 7.5H13.5M4.5 10.5H10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    Content Preview
  </h2>
  <div class="subtitle">Map and preview Contentful records</div>

  <div class="section">
    <label>
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">
        <path d="M12 0H2C0.895431 0 0 0.895431 0 2V12C0 13.1046 0.895431 14 2 14H12C13.1046 14 14 13.1046 14 12V2C14 0.895431 13.1046 0 12 0Z" fill="currentColor" opacity="0.2"/>
        <path d="M4 4H10M4 7H10M4 10H8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
      </svg>
      Select Content Type
    </label>
    <select id="content-type-select" disabled>
      <option value="">Loading content types...</option>
    </select>
    <button id="add-content-type" class="btn-small" style="margin-top: 8px; width: 100%;" disabled>+ Add Another Content Type</button>
  </div>

  <div class="section hidden" id="mapping-section">
    <div class="mapping-header">
      <label>
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">
          <path d="M5.5 0C4.39543 0 3.5 0.89543 3.5 2C3.5 2.73914 3.87011 3.38763 4.42499 3.76646L4.42499 5.75C4.42499 6.0537 4.25433 6.33319 3.98422 6.47533L1.98422 7.47533C1.71411 7.61747 1.54345 7.89696 1.54345 8.20066L1.54345 10.2335C0.988575 10.6123 0.618463 11.2608 0.618463 12C0.618463 13.1046 1.5139 14 2.61847 14C3.72304 14 4.61847 13.1046 4.61847 12C4.61847 11.2608 4.24836 10.6123 3.69349 10.2335L3.69349 8.66603L5.25349 7.86603C5.79358 7.58176 6.18832 7.09172 6.34377 6.51063C6.84293 6.70348 7.40448 6.72107 7.91754 6.53813L9.30654 9.31613C9.00154 9.65413 8.81848 10.101 8.81848 10.5905C8.81848 11.6951 9.71391 12.5905 10.8185 12.5905C11.9231 12.5905 12.8185 11.6951 12.8185 10.5905C12.8185 9.48596 11.9231 8.59053 10.8185 8.59053C10.534 8.59053 10.2659 8.64958 10.0232 8.75563L8.63417 5.97763C9.00517 5.63463 9.23654 5.14313 9.23654 4.59053C9.23654 3.48596 8.34111 2.59053 7.23654 2.59053C6.13197 2.59053 5.23654 3.48596 5.23654 4.59053C5.23654 5.13513 5.46241 5.62363 5.82841 5.96663C5.73691 6.29663 5.52241 6.58163 5.22841 6.75863L5.57501 5.76646C6.12988 5.38763 6.5 4.73914 6.5 4C6.5 2.89543 5.60457 2 4.5 2C3.39543 2 2.5 2.89543 2.5 4C2.5 5.10457 3.39543 6 4.5 6Z" fill="currentColor"/>
        </svg>
        Field Mappings
      </label>
      <button id="clear-mappings" class="btn-secondary" style="padding: 6px 12px; font-size: 12px;">Clear All</button>
    </div>
    
    <div id="content-type-groups">
      <!-- Content type groups will be added here -->
    </div>

    <div class="button-group" style="margin-top: 12px;">
      <button id="apply-mappings" class="btn-primary" disabled>Apply & Load Records</button>
    </div>
  </div>

  <div class="section hidden" id="record-navigation">
    <div class="record-header">
      <label>
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">
          <path d="M8.75 0H2.625C1.86561 0 1.25 0.61561 1.25 1.375V12.625C1.25 13.3844 1.86561 14 2.625 14H11.375C12.1344 14 12.75 13.3844 12.75 12.625V4.125L8.75 0Z" fill="currentColor" opacity="0.2"/>
          <path d="M8.75 0V4.125H12.75M4.375 7.875H9.625M4.375 10.5H9.625" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Record Preview
      </label>
      <div class="record-info">
        <span id="record-counter">Record 1 of 0</span>
      </div>
    </div>
    
    <div class="record-controls">
      <button id="prev-record" class="btn-nav" disabled>← Previous</button>
      <button id="next-record" class="btn-nav" disabled>Next →</button>
    </div>
    
    <div id="record-data" class="record-data">
      <!-- Current record data will be displayed here -->
    </div>
  </div>

  <div class="status-container">
    <div id="preview-status"></div>
  </div>
</div>

<!-- Settings View -->
<div class="container view" id="settings-view" style="height: 100vh; overflow-y: auto; display: flex; flex-direction: column; padding: 12px;">
  <div style="margin-bottom: 16px;">
    <h2 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 600;">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">
        <path d="M15.1875 9.5625C15.2156 9.3 15.2344 9.0375 15.2344 8.76562C15.2344 8.50312 15.2156 8.23125 15.1875 7.96875L17.0531 6.49688C17.2219 6.36562 17.2688 6.12187 17.1656 5.93437L15.3844 2.81562C15.2812 2.61875 15.0469 2.54062 14.8406 2.61875L12.6562 3.49687C12.2156 3.15937 11.7469 2.87812 11.2312 2.65312L10.8844 0.309375C10.8469 0.09375 10.6594 -0.015625 10.4344 -0.015625H6.87188C6.64688 -0.015625 6.46875 0.09375 6.43125 0.309375L6.08438 2.65312C5.56875 2.87812 5.09062 3.16875 4.65938 3.49687L2.475 2.61875C2.26875 2.53125 2.03437 2.61875 1.93125 2.81562L0.15 5.93437C0.0375 6.13125 0.09375 6.36562 0.2625 6.49688L2.12812 7.96875C2.1 8.23125 2.07188 8.5125 2.07188 8.76562C2.07188 9.01875 2.09062 9.3 2.11875 9.5625L0.253125 11.0344C0.084375 11.1656 0.0375 11.4094 0.140625 11.5969L1.92188 14.7156C2.025 14.9125 2.25938 14.9906 2.46562 14.9125L4.65 14.0344C5.09062 14.3719 5.55938 14.6531 6.075 14.8781L6.42188 17.2219C6.46875 17.4375 6.64688 17.5469 6.87188 17.5469H10.4344C10.6594 17.5469 10.8469 17.4375 10.875 17.2219L11.2219 14.8781C11.7375 14.6531 12.2156 14.3625 12.6469 14.0344L14.8312 14.9125C15.0375 15 15.2719 14.9125 15.375 14.7156L17.1562 11.5969C17.2594 11.4 17.2125 11.1656 17.0437 11.0344L15.1875 9.5625ZM8.65312 12.0938C6.79687 12.0938 5.29688 10.5938 5.29688 8.7375C5.29688 6.88125 6.79687 5.38125 8.65312 5.38125C10.5094 5.38125 12.0094 6.88125 12.0094 8.7375C12.0094 10.5938 10.5094 12.0938 8.65312 12.0938Z" fill="currentColor"/>
      </svg>
      Settings
    </h2>
    <div class="subtitle" style="margin: 0;">Configure your Contentful connection</div>
  </div>

  <div class="section" style="flex: 1; overflow-y: auto;">
    <div style="display: grid; gap: 16px;">
    <div class="config-field">
        <label style="display: block; font-weight: 600; font-size: 12px; margin-bottom: 6px;">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 3px;">
            <path d="M10 5.5H7V2.5C7 1.67157 6.32843 1 5.5 1C4.67157 1 4 1.67157 4 2.5V5.5H2C1.17157 5.5 0.5 6.17157 0.5 7C0.5 7.82843 1.17157 8.5 2 8.5H4V11.5C4 12.3284 4.67157 13 5.5 13C6.32843 13 7 12.3284 7 11.5V8.5H10C10.8284 8.5 11.5 7.82843 11.5 7C11.5 6.17157 10.8284 5.5 10 5.5Z" fill="currentColor"/>
          </svg>
          Space ID <span style="color: #f44336;">*</span>
        </label>
        <input type="text" id="space-id" placeholder="Enter your Contentful Space ID" style="width: 100%; box-sizing: border-box;" />
    </div>

    <div class="config-field">
        <label style="display: block; font-weight: 600; font-size: 12px; margin-bottom: 6px;">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 3px;">
            <path d="M10 5H9.5V3.5C9.5 2.11929 8.38071 1 7 1H5C3.61929 1 2.5 2.11929 2.5 3.5V5H2C1.17157 5 0.5 5.67157 0.5 6.5V10C0.5 10.8284 1.17157 11.5 2 11.5H10C10.8284 11.5 11.5 10.8284 11.5 10V6.5C11.5 5.67157 10.8284 5 10 5ZM4 3.5C4 2.94772 4.44772 2.5 5 2.5H7C7.55228 2.5 8 2.94772 8 3.5V5H4V3.5Z" fill="currentColor"/>
          </svg>
          CMA Token <span style="color: #f44336;">*</span>
        </label>
        <input type="password" id="cma-token" placeholder="Enter your CMA token" style="width: 100%; box-sizing: border-box;" />
        <div style="font-size: 10px; color: var(--figma-text-tertiary); margin-top: 4px;">Content Management API token</div>
    </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
    <div class="config-field">
          <label style="display: block; font-weight: 600; font-size: 12px; margin-bottom: 6px;">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 3px;">
              <path d="M6 0C2.68629 0 0 2.68629 0 6C0 9.31371 2.68629 12 6 12C9.31371 12 12 9.31371 12 6C12 2.68629 9.31371 0 6 0ZM9.9011 3.6H8.23127C7.98445 2.61034 7.61124 1.66526 7.12601 0.816891C8.51339 1.26842 9.64845 2.27905 10.1697 3.6H9.9011ZM6 1.22243C6.63707 2.13429 7.12589 3.13917 7.42777 4.2H4.57223C4.87411 3.13917 5.36293 2.13429 6 1.22243ZM1.31493 7.2C1.21489 6.81103 1.18 6.41306 1.18 6C1.18 5.58694 1.21489 5.18897 1.31493 4.8H3.25792C3.21442 5.19797 3.18857 5.59594 3.18857 6C3.18857 6.40406 3.21442 6.80203 3.25792 7.2H1.31493ZM2.0989 8.4H3.76873C4.01555 9.38966 4.38876 10.3347 4.87399 11.1831C3.48661 10.7316 2.35155 9.72095 1.8303 8.4H2.0989ZM3.76873 3.6H2.0989C2.35155 2.27905 3.48661 1.26842 4.87399 0.816891C4.38876 1.66526 4.01555 2.61034 3.76873 3.6ZM6 10.7776C5.36293 9.86571 4.87411 8.86083 4.57223 7.8H7.42777C7.12589 8.86083 6.63707 9.86571 6 10.7776ZM7.7397 7.2H4.2603C4.20634 6.80203 4.19143 6.40406 4.19143 6C4.19143 5.59594 4.20634 5.19797 4.2603 4.8H7.7397C7.79366 5.19797 7.80857 5.59594 7.80857 6C7.80857 6.40406 7.79366 6.80203 7.7397 7.2ZM7.12601 11.1831C7.61124 10.3347 7.98445 9.38966 8.23127 8.4H9.9011C9.38986 9.72095 8.51339 10.7316 7.12601 11.1831ZM8.74208 7.2C8.78558 6.80203 8.81143 6.40406 8.81143 6C8.81143 5.59594 8.78558 5.19797 8.74208 4.8H10.6851C10.7851 5.18897 10.82 5.58694 10.82 6C10.82 6.41306 10.7851 6.81103 10.6851 7.2H8.74208Z" fill="currentColor"/>
            </svg>
            Environment
          </label>
          <input type="text" id="environment" placeholder="master" style="width: 100%; box-sizing: border-box;" />
    </div>

    <div class="config-field">
          <label style="display: block; font-weight: 600; font-size: 12px; margin-bottom: 6px;">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 3px;">
              <path d="M10.2857 0H1.71429C0.768 0 0 0.768 0 1.71429V10.2857C0 11.232 0.768 12 1.71429 12H10.2857C11.232 12 12 11.232 12 10.2857V1.71429C12 0.768 11.232 0 10.2857 0Z" fill="currentColor" opacity="0.2"/>
              <path d="M3.42857 3.42857H8.57143M3.42857 6H8.57143M3.42857 8.57143H6.85714" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
            </svg>
            Content Type
          </label>
          <input type="text" id="content-type" placeholder="translation" style="width: 100%; box-sizing: border-box;" />
        </div>
    </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
    <div class="config-field">
          <label style="display: block; font-weight: 600; font-size: 12px; margin-bottom: 6px;">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 3px;">
              <path d="M10 5.5H7V2.5C7 1.67157 6.32843 1 5.5 1C4.67157 1 4 1.67157 4 2.5V5.5H2C1.17157 5.5 0.5 6.17157 0.5 7C0.5 7.82843 1.17157 8.5 2 8.5H4V11.5C4 12.3284 4.67157 13 5.5 13C6.32843 13 7 12.3284 7 11.5V8.5H10C10.8284 8.5 11.5 7.82843 11.5 7C11.5 6.17157 10.8284 5.5 10 5.5Z" fill="currentColor"/>
            </svg>
            Key Field
          </label>
          <input type="text" id="key-field" placeholder="key" style="width: 100%; box-sizing: border-box;" />
    </div>

    <div class="config-field">
          <label style="display: block; font-weight: 600; font-size: 12px; margin-bottom: 6px;">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 3px;">
              <path d="M10.5 2.5H1.5C0.671573 2.5 0 3.17157 0 4V8.5C0 9.32843 0.671573 10 1.5 10H10.5C11.3284 10 12 9.32843 12 8.5V4C12 3.17157 11.3284 2.5 10.5 2.5Z" fill="currentColor" opacity="0.2"/>
              <path d="M3 5.5H4.5M3 7H7.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
            </svg>
            Value Field
          </label>
          <input type="text" id="value-field" placeholder="value" style="width: 100%; box-sizing: border-box;" />
        </div>
    </div>

    <div class="config-field">
        <label style="display: block; font-weight: 600; font-size: 12px; margin-bottom: 6px;">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 3px;">
            <path d="M6 0C2.68629 0 0 2.68629 0 6C0 9.31371 2.68629 12 6 12C9.31371 12 12 9.31371 12 6C12 2.68629 9.31371 0 6 0ZM6 10.5C3.51472 10.5 1.5 8.48528 1.5 6C1.5 3.51472 3.51472 1.5 6 1.5C8.48528 1.5 10.5 3.51472 10.5 6C10.5 8.48528 8.48528 10.5 6 10.5Z" fill="currentColor"/>
            <circle cx="6" cy="6" r="2.5" fill="currentColor"/>
          </svg>
          Node Name Pattern (Regex)
        </label>
        <input type="text" id="node-pattern" placeholder="^jams_" style="width: 100%; box-sizing: border-box;" />
        <div style="font-size: 10px; color: var(--figma-text-tertiary); margin-top: 4px;">Only nodes matching this pattern will be loaded</div>
      </div>
    </div>
    
    <div class="config-actions" style="margin-top: 16px; display: flex; gap: 8px;">
      <button class="btn-primary" id="save-config" style="flex: 1;">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">
          <path d="M12.25 0H1.75C0.784 0 0 0.784 0 1.75V12.25C0 13.216 0.784 14 1.75 14H12.25C13.216 14 14 13.216 14 12.25V1.75C14 0.784 13.216 0 12.25 0ZM10.5 1.75V5.25H3.5V1.75H10.5ZM1.75 12.25V1.75H2.625V6.125C2.625 6.60825 3.01675 7 3.5 7H10.5C10.9832 7 11.375 6.60825 11.375 6.125V1.75H12.25V12.25H1.75Z" fill="currentColor"/>
          <rect x="8.75" y="2.625" width="0.875" height="3.5" fill="currentColor"/>
        </svg>
        Save & Validate
      </button>
  </div>

    <!-- Reset link -->
    <div style="margin-top: 24px; text-align: right;">
      <a href="#" id="reset-config" style="font-size: 12px; color: var(--figma-text-secondary); text-decoration: none;">Reset all fields to default</a>
    </div>

  </div>

  <button class="btn-secondary" id="back-to-main" style="width: calc(100% - 24px); margin: 0 12px 12px 12px; flex-shrink: 0;">← Back to Translator</button>

  <div class="status-container">
    <div id="settings-status"></div>
  </div>
</div>

<script>
let config = null;
let isLoading = false;

const defaultConfig = {
  SPACE_ID: "",
  ENVIRONMENT: "master",
  CMA_TOKEN: "",
  CONTENT_TYPE: "translation",
  KEY_FIELD: "key",
  VALUE_FIELD: "value",
  NODE_NAME_PATTERN: "^jams_"
};

// Check if configuration is complete
function isConfigComplete(cfg) {
  if (!cfg) return false;
  // Required fields that user must fill
  return !!(cfg.SPACE_ID && cfg.SPACE_ID.trim() && cfg.CMA_TOKEN && cfg.CMA_TOKEN.trim());
}

// Detect and apply Figma theme
function applyFigmaTheme() {
  // Figma provides --figma-color-bg when themeColors is enabled
  const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--figma-color-bg').trim();
  
  if (bgColor) {
    // Parse the RGB value to determine if it's dark or light
    const rgb = bgColor.match(/\d+/g);
    if (rgb && rgb.length >= 3) {
      const r = parseInt(rgb[0]);
      const g = parseInt(rgb[1]);
      const b = parseInt(rgb[2]);
      
      // Calculate relative luminance
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      
      // If dark theme (luminance < 0.5), apply dark class
      if (luminance < 0.5) {
        document.body.classList.add('figma-dark');
      } else {
        document.body.classList.remove('figma-dark');
      }
    }
  }
}

// Apply theme on load
applyFigmaTheme();

// Watch for theme changes
const observer = new MutationObserver(applyFigmaTheme);
observer.observe(document.documentElement, { 
  attributes: true, 
  attributeFilter: ['style'] 
});

// Request config and start auto-load on startup
parent.postMessage({ pluginMessage: { type: 'init' } }, '*');

// View switching - wait for DOM to be ready
window.addEventListener('DOMContentLoaded', () => {
  const settingsBtn = document.getElementById('settings-toggle-inline');
  if (settingsBtn) {
    settingsBtn.onclick = () => {
      console.log('Settings button clicked');
      switchView('settings');
    };
  } else {
    console.error('Settings button not found!');
  }

  const backBtn = document.getElementById('back-to-main');
  if (backBtn) {
    backBtn.onclick = () => {
      switchView('write');
    };
  }
});

function switchView(viewName) {
  console.log('switchView called with:', viewName);
  
  const targetView = document.getElementById(`${viewName}-view`);
  console.log('Target view element:', targetView);
  
  if (!targetView) {
    console.error(`View "${viewName}-view" not found!`);
    return;
  }
  
  // Remove active from all views
  document.querySelectorAll('.view').forEach(v => {
    console.log('Removing active from:', v.id, v.classList.contains('active'));
    v.classList.remove('active');
    v.style.display = 'none'; // Force hide
  });
  
  // Activate target view
  targetView.classList.add('active');
  targetView.style.display = 'block'; // Force show
  console.log('Activated view:', targetView.id, targetView.classList.contains('active'));
  
  if (viewName === 'settings') {
    loadConfigIntoEditor();
  }
}

// Settings functionality
function loadConfigIntoEditor() {
  const configToLoad = config || defaultConfig;
  
  document.getElementById('space-id').value = configToLoad.SPACE_ID || '';
  document.getElementById('environment').value = configToLoad.ENVIRONMENT || '';
  document.getElementById('cma-token').value = configToLoad.CMA_TOKEN || '';
  document.getElementById('content-type').value = configToLoad.CONTENT_TYPE || '';
  document.getElementById('key-field').value = configToLoad.KEY_FIELD || '';
  document.getElementById('value-field').value = configToLoad.VALUE_FIELD || '';
  document.getElementById('node-pattern').value = configToLoad.NODE_NAME_PATTERN || '';
}

function getConfigFromFields() {
  return {
    SPACE_ID: document.getElementById('space-id').value.trim(),
    ENVIRONMENT: document.getElementById('environment').value.trim(),
    CMA_TOKEN: document.getElementById('cma-token').value.trim(),
    CONTENT_TYPE: document.getElementById('content-type').value.trim(),
    KEY_FIELD: document.getElementById('key-field').value.trim(),
    VALUE_FIELD: document.getElementById('value-field').value.trim(),
    NODE_NAME_PATTERN: document.getElementById('node-pattern').value.trim()
  };
}

document.getElementById('save-config').onclick = async () => {
  const newConfig = getConfigFromFields();

  // Show validation modal
  showValidationModal();

  // Disable the save button
  document.getElementById('save-config').disabled = true;

  // Run preflight checks step by step
  await runPreflightChecks(newConfig);
};

// Show reset confirmation modal
document.getElementById('reset-config').onclick = (e) => {
  e.preventDefault();
  showResetModal();
};

// Show reset modal
function showResetModal() {
  document.getElementById('reset-modal').classList.add('show');
}

// Hide reset modal
function hideResetModal() {
  document.getElementById('reset-modal').classList.remove('show');
}

// Confirm reset action
function confirmReset() {
  hideResetModal();
  loadConfigIntoEditor();
}

async function runPreflightChecks(newConfig) {
  const steps = [
    { id: 'preflight-validate', check: () => validateConfig(newConfig), delay: 800 },
    { id: 'preflight-locales', check: () => testLocales(newConfig), delay: 1500 },
    { id: 'preflight-content', check: () => checkContentType(newConfig), delay: 1000 },
    { id: 'preflight-save', check: () => saveConfig(newConfig), delay: 600 }
  ];
  
  for (const step of steps) {
    const element = document.getElementById(step.id);

    // Mark as checking
    element.classList.remove('success', 'error');
    element.classList.add('checking');
    const icon = element.querySelector('.preflight-icon');
    icon.innerHTML = `
      <svg class="spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="spinnerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:var(--figma-accent);stop-opacity:1" />
            <stop offset="100%" style="stop-color:var(--figma-accent);stop-opacity:0.3" />
          </linearGradient>
        </defs>
        <circle cx="12" cy="12" r="10" stroke="var(--figma-border)" stroke-width="3" opacity="0.2"/>
        <circle cx="12" cy="12" r="10" stroke="url(#spinnerGradient)" stroke-width="3" stroke-linecap="round" stroke-dasharray="15 50"/>
      </svg>
    `;
    
    // Wait a bit so user can see the step
    await new Promise(resolve => setTimeout(resolve, step.delay));
    
    try {
      const result = await step.check();

      if (result.success) {
        element.classList.remove('checking');
        element.classList.add('success');

        element.querySelector('.preflight-icon').innerHTML = `
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" fill="var(--green-500)"/>
            <path d="M8 12 L11 15 L16 9" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;

        if (result.message) {
          element.querySelector('.preflight-text').textContent = result.message;
        }
      } else {
        throw new Error(result.error || 'Check failed');
      }
    } catch (error) {
      element.classList.remove('checking');
      element.classList.add('error');
      element.querySelector('.preflight-icon').innerHTML = `
        <svg viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" fill="var(--red-500)"/>
          <path d="M8 8 L16 16 M16 8 L8 16" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        </svg>
      `;
      element.querySelector('.preflight-text').textContent = error.message;

      document.getElementById('save-config').disabled = false;

      // Show error message in modal
      const statusDiv = document.getElementById('validation-status');
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<div style="color: var(--red-600); font-weight: 500; padding: 12px; background: var(--red-50); border-radius: 6px;">' + error.message + '</div>';

      // Show close button
      document.getElementById('validation-close-btn').style.display = 'flex';
      document.getElementById('validation-footer').style.display = 'flex';
      return;
    }
  }
  
  // All checks passed!
  document.getElementById('save-config').disabled = false;

  // Show success message in modal
  const statusDiv = document.getElementById('validation-status');
  statusDiv.style.display = 'block';
  statusDiv.innerHTML = '<div style="color: var(--green-600); font-weight: 500; padding: 12px; background: var(--green-50); border-radius: 6px;">Configuration saved successfully!</div>';

  // Show close button
  document.getElementById('validation-close-btn').style.display = 'flex';
  document.getElementById('validation-footer').style.display = 'flex';
}

function validateConfig(cfg) {
  return new Promise((resolve) => {
    // Check all required fields
    const required = ['SPACE_ID', 'ENVIRONMENT', 'CMA_TOKEN', 'CONTENT_TYPE', 'KEY_FIELD', 'VALUE_FIELD', 'NODE_NAME_PATTERN'];
    const missing = required.filter(field => !cfg[field]);
    
    if (missing.length > 0) {
      resolve({ success: false, error: `Missing fields: ${missing.join(', ')}` });
      return;
    }
    
    // Validate regex pattern
    try {
      new RegExp(cfg.NODE_NAME_PATTERN);
  } catch (e) {
      resolve({ success: false, error: 'Invalid regex pattern' });
      return;
    }
    
    resolve({ success: true, message: 'All fields validated' });
  });
}

function testLocales(cfg) {
  return new Promise((resolve) => {
    let isResolved = false;
    
    const messageHandler = (event) => {
      if (!isResolved && event.data?.pluginMessage?.type === 'preflight-locales-result') {
        isResolved = true;
        window.removeEventListener('message', messageHandler);
        resolve(event.data.pluginMessage.result);
      }
    };
    
    window.addEventListener('message', messageHandler);
    
    // Send test request - fetching locales validates credentials, space, and environment all at once
    parent.postMessage({ pluginMessage: { type: 'preflight-test-locales', config: cfg } }, '*');
    
    // Timeout after 10 seconds
    setTimeout(() => {
      if (!isResolved) {
        isResolved = true;
        window.removeEventListener('message', messageHandler);
        resolve({ success: false, error: 'Locales fetch timeout' });
      }
    }, 10000);
  });
}

function checkContentType(cfg) {
  return new Promise((resolve) => {
    let isResolved = false;
    
    const messageHandler = (event) => {
      if (!isResolved && event.data?.pluginMessage?.type === 'preflight-content-result') {
        isResolved = true;
        window.removeEventListener('message', messageHandler);
        resolve(event.data.pluginMessage.result);
      }
    };
    
    window.addEventListener('message', messageHandler);
    parent.postMessage({ pluginMessage: { type: 'preflight-check-content', config: cfg } }, '*');
    
    setTimeout(() => {
      if (!isResolved) {
        isResolved = true;
        window.removeEventListener('message', messageHandler);
        resolve({ success: false, error: 'Content type check timeout' });
      }
    }, 10000);
  });
}

function saveConfig(cfg) {
  return new Promise((resolve) => {
    let isResolved = false;
    
    const messageHandler = (event) => {
      if (isResolved) return;
      
      if (event.data?.pluginMessage?.type === 'config-saved') {
        isResolved = true;
        window.removeEventListener('message', messageHandler);
        config = event.data.pluginMessage.config;
        resolve({ success: true, message: 'Configuration saved successfully' });
      } else if (event.data?.pluginMessage?.type === 'config-save-failed') {
        isResolved = true;
        window.removeEventListener('message', messageHandler);
        resolve({ success: false, error: event.data.pluginMessage.message });
      }
    };
    
    window.addEventListener('message', messageHandler);
    parent.postMessage({ pluginMessage: { type: 'save-config', config: cfg } }, '*');
    
    setTimeout(() => {
      if (!isResolved) {
        isResolved = true;
        window.removeEventListener('message', messageHandler);
        resolve({ success: false, error: 'Save timeout' });
      }
    }, 5000);
  });
}

function setSettingsStatus(text, type = 'info') {
  const status = document.getElementById('settings-status');
  status.className = type;
  
  // Clear previous content
  while (status.firstChild) {
    status.removeChild(status.firstChild);
  }
  
  if (type === 'loading') {
    const spinner = document.createElement('span');
    spinner.className = 'spinner';
    const textSpan = document.createElement('span');
    textSpan.textContent = text;
    status.appendChild(spinner);
    status.appendChild(textSpan);
  } else {
    status.textContent = text;
  }
}

document.getElementById('apply-translation').onclick = () => {
  const localeSelect = document.getElementById('locale');
  const locale = localeSelect.value;
  if (!locale) {
    setStatus('Please select a language first', 'error');
    return;
  }
  if (!config) {
    setStatus('Configuration not loaded', 'error');
    return;
  }
  
  setStatus('Applying translations...', 'loading');
  disableUI(true);
  parent.postMessage({ pluginMessage: { type: 'apply-translation', config, locale } }, '*');
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
}

// ========== Write Mode Functionality ==========

let textItems = [];
let contentfulItems = {};

document.getElementById('btn-load-items').onclick = async () => {
  if (!config) {
    setWriteStatus('Please configure Contentful connection first', 'error');
    return;
  }
  
  console.log('Load button clicked - fetching fresh data from Figma and Contentful');
  setWriteStatus('Loading text items...', 'loading');
  
  // Clear existing data to force fresh fetch
  textItems = [];
  contentfulItems = {};
  
  // Fetch text nodes from Figma
  parent.postMessage({ pluginMessage: { type: 'get-translatable-nodes', config } }, '*');
};

function setWriteStatus(text, type = 'info') {
  const status = document.getElementById('write-status');
  status.className = type;
  status.textContent = text;
}

async function loadItemsAndCheckStatus(items) {
  console.log('📝 Loaded', items.length, 'text items from Figma');
  textItems = items;
  
  if (items.length === 0) {
    setWriteStatus('No translatable text items found', 'info');
    return;
  }
  
  // Check for duplicate names
  const nameCount = {};
  const duplicates = [];
  items.forEach(item => {
    nameCount[item.name] = (nameCount[item.name] || 0) + 1;
    if (nameCount[item.name] > 1 && !duplicates.includes(item.name)) {
      duplicates.push(item.name);
    }
  });
  
  if (duplicates.length > 0) {
    console.warn('DUPLICATE NODE NAMES DETECTED:');
    duplicates.forEach(name => {
      console.warn(`  - "${name}" appears ${nameCount[name]} times`);
      const dupeItems = items.filter(item => item.name === name);
      dupeItems.forEach((item, idx) => {
        console.warn(`    ${idx + 1}. ID: ${item.id}, Text: "${item.characters.substring(0, 50)}..."`);
      });
    });
    setWriteStatus(`Warning: ${duplicates.length} duplicate name(s) found - check console`, 'error');
  }
  
  // Always fetch fresh data from Contentful to get the latest state
  console.log('Fetching fresh data from Contentful...');
  setWriteStatus('Fetching from Contentful...', 'loading');
  parent.postMessage({ pluginMessage: { type: 'get-all-contentful-items', config } }, '*');
}

function renderItemsTable() {
  try {
    const tbody = document.getElementById('items-table-body');
    if (!tbody) {
      console.error('Table body element not found');
      return;
    }
    
    tbody.innerHTML = '';
    
    // Validate textItems array
    if (!Array.isArray(textItems)) {
      console.error('textItems is not an array');
      setWriteStatus('Error: Invalid data structure', 'error');
      return;
    }
    
    // Get search filter
    const searchInput = document.getElementById('search-input');
    const searchTerm = (searchInput?.value || '').toLowerCase().trim();
    
    // Filter items based on search (search in both key name and text content)
    const filteredItems = textItems.filter(item => {
      if (!item || typeof item !== 'object') return false;
      
      const name = String(item.name || '').toLowerCase();
      const characters = String(item.characters || '').toLowerCase();
      
      return name.includes(searchTerm) || characters.includes(searchTerm);
    });
    
    filteredItems.forEach((item) => {
      const originalIndex = textItems.findIndex(original => 
        original && original.id === item.id
      );
      
      if (originalIndex === -1) {
        console.warn('Could not find original index for item:', item.id);
        return; // Skip this item
      }
    const tr = document.createElement('tr');
    
    // Add click handler to filter by this item
    tr.style.cursor = 'pointer';
    tr.onclick = (e) => {
      // Don't trigger if clicking a button
      if (e.target.tagName === 'BUTTON') return;
      
      const searchInput = document.getElementById('search-input');
      searchInput.value = item.name;
      searchInput.dispatchEvent(new Event('input'));
      searchInput.focus();
    };
    
    // Key column
    const keyTd = document.createElement('td');
    const contentfulItem = contentfulItems[item.name];
    
    if (contentfulItem && contentfulItem.id) {
      // Create clickable link to Contentful
      // Correct Contentful web app URL format with environment
      const link = document.createElement('a');
      const contentfulUrl = `https://app.contentful.com/spaces/${encodeURIComponent(config.SPACE_ID)}/environments/${encodeURIComponent(config.ENVIRONMENT)}/entries/${encodeURIComponent(contentfulItem.id)}`;
      
      link.href = contentfulUrl;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.className = 'contentful-link';
      link.textContent = item.name;
      link.title = 'Open in Contentful';
      link.onclick = (e) => {
        e.stopPropagation(); // Prevent row click handler
      };
      keyTd.appendChild(link);
    } else {
      // No link for new items
      keyTd.textContent = item.name;
      keyTd.style.fontWeight = '600';
    }
    
    tr.appendChild(keyTd);
    
    // Text column
    const textTd = document.createElement('td');
    const textDiv = document.createElement('div');
    textDiv.className = 'text-preview';
    textDiv.textContent = item.characters;
    textDiv.title = item.characters;
    textTd.appendChild(textDiv);
    tr.appendChild(textTd);
    
    // Status column
    const statusTd = document.createElement('td');
    const statusBadge = document.createElement('span');
    statusBadge.className = 'status-badge checking';
    statusBadge.id = `status-${originalIndex}`;
    if (!contentfulItem) {
      statusBadge.className = 'status-badge not-exists';
      statusBadge.textContent = '+';
      statusBadge.title = 'New - Does not exist in Contentful';
    } else {
      // Bulletproof comparison with normalization
      const figmaText = normalizeText(item.characters);
      const contentfulText = normalizeText(contentfulItem.value);
      const isEqual = textsAreEqual(item.characters, contentfulItem.value);
      
      console.log(`Comparing "${item.name}":`);
      console.log('  Figma Raw:', `"${item.characters}"`);
      console.log('  Figma Normalized:', `"${figmaText}"`);
      console.log('  Contentful Raw:', `"${contentfulItem.value}"`);
      console.log('  Contentful Normalized:', `"${contentfulText}"`);
      console.log('  Equal:', isEqual);
      console.log('  Lengths:', { figma: figmaText.length, contentful: contentfulText.length });
      if (!isEqual) {
        console.log('  Figma Char Codes:', Array.from(figmaText).map(c => c.charCodeAt(0)));
        console.log('  Contentful Char Codes:', Array.from(contentfulText).map(c => c.charCodeAt(0)));
      }
      
      if (!isEqual) {
        statusBadge.className = 'status-badge out-of-sync';
        statusBadge.textContent = '!';
        statusBadge.title = `Contentful: "${contentfulText}"`;
      } else {
        statusBadge.className = 'status-badge synced';
        statusBadge.innerHTML = '<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.6 3.2L5.6 10.2L2 6.6L3.4 5.2L5.6 7.4L11.2 1.8L12.6 3.2Z" fill="currentColor"/></svg>';
        statusBadge.title = 'Synced - Matches Contentful';
      }
    }
    
    statusTd.appendChild(statusBadge);
    tr.appendChild(statusTd);
    
    // Action column
    const actionTd = document.createElement('td');
    
    const needsUpdate = !contentfulItem || !textsAreEqual(item.characters, contentfulItem.value);
    
    if (needsUpdate) {
      const saveBtn = document.createElement('button');
      saveBtn.className = 'btn-save-item';
      saveBtn.textContent = contentfulItem ? 'Update' : 'Create';
      saveBtn.onclick = () => saveItemToContentful(item, originalIndex);
      actionTd.appendChild(saveBtn);
    }
    
    tr.appendChild(actionTd);
      tbody.appendChild(tr);
    });
    
    const tableSection = document.getElementById('items-table-section');
    if (tableSection) {
      tableSection.classList.remove('hidden');
    }
    setWriteStatus('Ready', 'success');
  } catch (error) {
    console.error('Error rendering items table:', error);
    setWriteStatus('Error displaying items', 'error');
  }
}

// Search functionality
document.getElementById('search-input').addEventListener('input', () => {
  renderItemsTable();
});

// Bulletproof text normalization and comparison
function normalizeText(text) {
  if (!text) return '';
  return text
    .trim()                           // Remove leading/trailing whitespace
    .replace(/\s+/g, ' ')             // Normalize multiple spaces to single space
    .replace(/\u00A0/g, ' ')          // Replace non-breaking spaces with regular spaces
    .replace(/[\u200B-\u200D\uFEFF]/g, '') // Remove zero-width characters
    .normalize('NFC');                // Unicode normalization (canonical composition)
}

function textsAreEqual(text1, text2) {
  const normalized1 = normalizeText(text1);
  const normalized2 = normalizeText(text2);
  return normalized1 === normalized2;
}

function saveItemToContentful(item, index) {
  const statusBadge = document.getElementById(`status-${index}`);
  statusBadge.className = 'status-badge checking';
  statusBadge.innerHTML = '<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 0C3.13401 0 0 3.13401 0 7C0 10.866 3.13401 14 7 14C10.866 14 14 10.866 14 7C14 3.13401 10.866 0 7 0ZM7 12.25C4.10051 12.25 1.75 9.89949 1.75 7C1.75 4.10051 4.10051 1.75 7 1.75C9.89949 1.75 12.25 4.10051 12.25 7C12.25 9.89949 9.89949 12.25 7 12.25Z" fill="currentColor"/><path d="M7 3.5C6.51675 3.5 6.125 3.89175 6.125 4.375V7.36493L4.63128 8.85866C4.28333 9.20661 4.28333 9.76839 4.63128 10.1163C4.97923 10.4643 5.54101 10.4643 5.88896 10.1163L7.62896 8.37634C7.78281 8.22249 7.875 8.01676 7.875 7.80117V4.375C7.875 3.89175 7.48325 3.5 7 3.5Z" fill="currentColor"/></svg>';
  statusBadge.title = 'Saving...';
  
  const isUpdate = !!contentfulItems[item.name];
  const entryId = isUpdate ? contentfulItems[item.name].id : null;
  
  parent.postMessage({ 
    pluginMessage: { 
      type: 'save-contentful-item',
      config,
      item: {
        key: item.name,
        value: item.characters,
        entryId: entryId,
        isUpdate: isUpdate
      }
    } 
  }, '*');
}

function updateItemStatus(key, success, errorMsg, errorDetails) {
  console.log('=== updateItemStatus called ===');
  console.log('Key:', key);
  console.log('Success:', success);
  console.log('Error:', errorMsg);
  console.log('Error Details:', errorDetails);
  
  if (success) {
    console.log('Save successful, refreshing from Contentful...');

    // Instead of updating cache manually, re-fetch from Contentful to get the REAL state
    setWriteStatus(`${key} saved, refreshing...`, 'success');
    parent.postMessage({ pluginMessage: { type: 'get-all-contentful-items', config } }, '*');
  } else {
    // On error, update status badge and show detailed error modal
    const index = textItems.findIndex(item => item.name === key);
    if (index !== -1) {
      const statusBadge = document.getElementById(`status-${index}`);
      if (statusBadge) {
        statusBadge.className = 'status-badge out-of-sync';
        statusBadge.innerHTML = '<svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12.25 1.75L1.75 12.25M1.75 1.75L12.25 12.25" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
        statusBadge.title = `Error: ${errorMsg}`;
      }
    }
    
    // Show brief error in status bar
    setWriteStatus(`Failed: ${errorMsg}`, 'error');
    
    // Show detailed error modal if we have details
    if (errorDetails) {
      showErrorModal(
        `Failed to save "${key}"`,
        errorMsg || 'An unknown error occurred',
        errorDetails
      );
    }
  }
}

document.getElementById('locale').onchange = () => {
  const btn = document.getElementById('apply-translation');
  btn.disabled = false;
}

window.onmessage = (event) => {
  // Security: validate message source and structure
  if (!event || !event.data || !event.data.pluginMessage) return;
  
  const msg = event.data.pluginMessage;
  if (!msg || typeof msg !== 'object' || !msg.type) return;
  
  if (msg.type === 'config-loaded') {
    // Validate config structure
    if (!msg.config || typeof msg.config !== 'object') {
      setStatus('Invalid configuration received', 'error');
      return;
    }
    config = msg.config;
    
    // Check if configuration is complete (has Space ID and CMA Token)
    if (!isConfigComplete(config)) {
      // Show onboarding/settings screen
      switchView('settings');
      setSettingsStatus('Welcome! Please configure your Contentful connection to get started.', 'info');
      return;
    }
    
    // Config is complete - automatically load text items
    setWriteStatus('Loading text items...', 'loading');
    
    // Clear existing data to force fresh fetch
    textItems = [];
    contentfulItems = {};
    
    // Automatically fetch text nodes from Figma
    parent.postMessage({ pluginMessage: { type: 'get-translatable-nodes', config } }, '*');
  }
  
  if (msg.type === 'node-count') {
    const count = parseInt(msg.count, 10);
    if (!isNaN(count) && count >= 0) {
      updateNodeCount(count);
    }
  }
  
  if (msg.type === 'locales-loaded') {
    const select = document.getElementById('locale');
    select.innerHTML = '<option value="">Choose a language...</option>';
    select.disabled = false;
    
    if (Array.isArray(msg.locales)) {
      for (const loc of msg.locales) {
        if (loc && loc.code && loc.name) {
          const opt = document.createElement('option');
          opt.value = sanitizeString(loc.code);
          opt.textContent = `${sanitizeString(loc.name)} (${sanitizeString(loc.code)})`;
          select.appendChild(opt);
        }
      }
      updateLocaleCount(msg.locales.length);
      setStatus(`Ready! ${msg.locales.length} language(s) available`, 'success');
      disableUI(false);
    } else {
      setStatus('Invalid locales data received', 'error');
    }
  }
  
  if (msg.type === 'translation-applied') {
    const count = parseInt(msg.count, 10);
    if (!isNaN(count) && count >= 0) {
      setStatus(`Success! Updated ${count} text node(s)`, 'success');
      disableUI(false);

      // Celebrate with a brief delay then show ready state
      setTimeout(() => {
        setStatus(`Ready to translate`, 'info');
      }, 2000);
    }
  }
  
  if (msg.type === 'error') {
    const errorMsg = sanitizeString(msg.message || 'Unknown error occurred');
    setStatus(errorMsg, 'error');
    disableUI(false);
  }
  
  // Settings responses
  if (msg.type === 'config-saved') {
    config = msg.config;
    // Note: Individual handlers in saveConfig() promise already handle this
  }

  if (msg.type === 'config-save-failed') {
    // Note: Individual handlers in saveConfig() promise already handle this
  }
}

function sanitizeString(str) {
  if (typeof str !== 'string') return '';
  // Remove any HTML tags and limit length
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML.substring(0, 500);
}

function setStatus(text, type = 'info') {
  const status = document.getElementById('status');
  status.className = type;
  
  // Clear previous content
  while (status.firstChild) {
    status.removeChild(status.firstChild);
  }
  
  if (type === 'loading') {
    const spinner = document.createElement('span');
    spinner.className = 'spinner';
    const textSpan = document.createElement('span');
    textSpan.textContent = text;
    status.appendChild(spinner);
    status.appendChild(textSpan);
  } else {
    status.textContent = text;
  }
}

function updateNodeCount(count) {
  const el = document.getElementById('node-count');
  el.textContent = count;
  el.style.animation = 'none';
  setTimeout(() => el.style.animation = 'success 0.4s ease-out', 10);
}

function updateLocaleCount(count) {
  const el = document.getElementById('locale-count');
  el.textContent = count;
  el.style.animation = 'none';
  setTimeout(() => el.style.animation = 'success 0.4s ease-out', 10);
}

function disableUI(disabled) {
  const btn = document.getElementById('apply-translation');
  const select = document.getElementById('locale');
  
  if (disabled) {
    btn.disabled = true;
  } else {
    btn.disabled = !select.value;
  }
}

// ========== Content Preview Mode ==========

let currentMode = 'translation';
let contentTypes = [];
let selectedContentType = null;
let contentTypeFields = [];
let contentTypeGroups = []; // Array of {contentType, fields, mappings}
let records = [];
let currentRecordIndex = 0;

// Mode switching
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const mode = btn.getAttribute('data-mode');
    switchMode(mode);
  });
});

function switchMode(mode) {
  currentMode = mode;
  
  // Update mode buttons
  document.querySelectorAll('.mode-btn').forEach(btn => {
    if (btn.getAttribute('data-mode') === mode) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
  
  // Show/hide views
  if (mode === 'translation') {
    document.getElementById('main-view').classList.add('active');
    document.getElementById('preview-view').classList.remove('active');
  } else if (mode === 'preview') {
    document.getElementById('main-view').classList.remove('active');
    document.getElementById('preview-view').classList.add('active');
    
    // Load content types if not loaded
    if (contentTypes.length === 0) {
      loadContentTypes();
    }
  }
}

function loadContentTypes() {
  if (!config) {
    setPreviewStatus('Configuration not loaded', 'error');
    return;
  }
  
  setPreviewStatus('Loading content types...', 'loading');
  parent.postMessage({ pluginMessage: { type: 'load-content-types', config } }, '*');
}

function setPreviewStatus(text, type = 'info') {
  const status = document.getElementById('preview-status');
  status.className = type;
  
  while (status.firstChild) {
    status.removeChild(status.firstChild);
  }
  
  if (type === 'loading') {
    const spinner = document.createElement('span');
    spinner.className = 'spinner';
    const textSpan = document.createElement('span');
    textSpan.textContent = text;
    status.appendChild(spinner);
    status.appendChild(textSpan);
  } else {
    status.textContent = text;
  }
}

// Content type selection
document.getElementById('content-type-select').addEventListener('change', (e) => {
  const contentTypeId = e.target.value;
  if (!contentTypeId) return;
  
  selectedContentType = contentTypes.find(ct => ct.sys.id === contentTypeId);
  if (selectedContentType) {
    addContentTypeGroup(selectedContentType);
    // Reset selector
    e.target.value = '';
  }
});

// Add another content type
document.getElementById('add-content-type').addEventListener('click', () => {
  const select = document.getElementById('content-type-select');
  if (select.value) {
    const contentType = contentTypes.find(ct => ct.sys.id === select.value);
    if (contentType) {
      addContentTypeGroup(contentType);
      select.value = '';
    }
  }
});

function addContentTypeGroup(contentType) {
  // Check if already added
  if (contentTypeGroups.some(g => g.contentType.sys.id === contentType.sys.id)) {
    setPreviewStatus(`Content type "${contentType.name}" already added`, 'error');
    return;
  }
  
  const groupId = Date.now();
  const group = {
    id: groupId,
    contentType: contentType,
    fields: contentType.fields || [],
    mappings: []
  };
  
  contentTypeGroups.push(group);
  
  // Show mapping section
  document.getElementById('mapping-section').classList.remove('hidden');
  
  // Hide record navigation
  document.getElementById('record-navigation').classList.add('hidden');
  
  // Create group UI
  const groupDiv = document.createElement('div');
  groupDiv.className = 'content-type-group';
  groupDiv.setAttribute('data-group-id', groupId);
  
  groupDiv.innerHTML = `
    <div class="content-type-group-header">
      <div class="content-type-title">
        <span class="content-type-badge">${sanitizeString(contentType.name)}</span>
        <span style="font-size: 11px; color: var(--figma-text-tertiary);">${group.fields.length} fields</span>
      </div>
      <button class="btn-remove-group" onclick="removeContentTypeGroup(${groupId})">Remove</button>
    </div>
    <div class="mappings-container" data-group-id="${groupId}">
      <!-- Mappings will be added here -->
    </div>
    <button class="add-field-btn" onclick="addMappingToGroup(${groupId})">+ Add Field Mapping</button>
  `;
  
  document.getElementById('content-type-groups').appendChild(groupDiv);
  
  setPreviewStatus(`Content type "${contentType.name}" added with ${group.fields.length} fields`, 'success');
  updateApplyButton();
  
  // Enable "Add Another" button
  document.getElementById('add-content-type').disabled = false;
}

// Add mapping to specific group
function addMappingToGroup(groupId) {
  const group = contentTypeGroups.find(g => g.id === groupId);
  if (!group) return;
  
  const mappingId = Date.now();
  const mappingDiv = document.createElement('div');
  mappingDiv.className = 'mapping-item';
  mappingDiv.setAttribute('data-mapping-id', mappingId);
  mappingDiv.setAttribute('data-group-id', groupId);
  
  mappingDiv.innerHTML = `
    <div class="mapping-row">
      <div class="mapping-field">
        <label>Content Field</label>
        <select class="field-select">
          <option value="">Select field...</option>
          ${group.fields.map(f => `<option value="${sanitizeString(f.id)}">${sanitizeString(f.name)} (${sanitizeString(f.id)})</option>`).join('')}
        </select>
      </div>
      <div class="mapping-field">
        <label>Text Node</label>
        <select class="node-select">
          <option value="">Select node...</option>
        </select>
      </div>
      <button class="btn-remove" onclick="removeMappingRow(${mappingId}, ${groupId})">Remove</button>
    </div>
  `;
  
  const container = document.querySelector(`.mappings-container[data-group-id="${groupId}"]`);
  if (container) {
    container.appendChild(mappingDiv);
  }
  
  // Request text nodes from Figma
  parent.postMessage({ pluginMessage: { type: 'get-text-nodes' } }, '*');
  
  updateApplyButton();
}

function removeMappingRow(mappingId, groupId) {
  const mappingDiv = document.querySelector(`[data-mapping-id="${mappingId}"]`);
  if (mappingDiv) {
    mappingDiv.remove();
  }
  updateApplyButton();
}

function removeContentTypeGroup(groupId) {
  const groupDiv = document.querySelector(`[data-group-id="${groupId}"].content-type-group`);
  if (groupDiv) {
    groupDiv.remove();
  }
  
  contentTypeGroups = contentTypeGroups.filter(g => g.id !== groupId);
  
  if (contentTypeGroups.length === 0) {
    document.getElementById('mapping-section').classList.add('hidden');
    document.getElementById('record-navigation').classList.add('hidden');
    document.getElementById('add-content-type').disabled = true;
  }
  
  updateApplyButton();
  setPreviewStatus('Content type removed', 'info');
}

function updateApplyButton() {
  const mappingItems = document.querySelectorAll('.mapping-item');
  document.getElementById('apply-mappings').disabled = mappingItems.length === 0;
}

// Clear all mappings
document.getElementById('clear-mappings').addEventListener('click', () => {
  contentTypeGroups = [];
  document.getElementById('content-type-groups').innerHTML = '';
  document.getElementById('mapping-section').classList.add('hidden');
  document.getElementById('record-navigation').classList.add('hidden');
  document.getElementById('add-content-type').disabled = true;
  updateApplyButton();
  setPreviewStatus('All mappings cleared', 'info');
});

// Apply mappings and load records from all content types
document.getElementById('apply-mappings').addEventListener('click', () => {
  if (contentTypeGroups.length === 0) {
    setPreviewStatus('No content types configured', 'error');
    return;
  }
  
  // Collect all mappings from all groups with content type info
  const allMappings = [];
  const contentTypesToLoad = [];
  
  contentTypeGroups.forEach(group => {
    const groupMappings = [];
    const container = document.querySelector(`.mappings-container[data-group-id="${group.id}"]`);
    
    if (container) {
      container.querySelectorAll('.mapping-item').forEach(item => {
        const fieldSelect = item.querySelector('.field-select');
        const nodeSelect = item.querySelector('.node-select');
        
        if (fieldSelect.value && nodeSelect.value) {
          groupMappings.push({
            field: fieldSelect.value,
            node: nodeSelect.value,
            contentTypeId: group.contentType.sys.id
          });
        }
      });
    }
    
    if (groupMappings.length > 0) {
      allMappings.push(...groupMappings);
      if (!contentTypesToLoad.includes(group.contentType.sys.id)) {
        contentTypesToLoad.push(group.contentType.sys.id);
      }
    }
  });
  
  if (allMappings.length === 0) {
    setPreviewStatus('Please configure at least one mapping', 'error');
    return;
  }
  
  setPreviewStatus('Loading records from multiple content types...', 'loading');
  
  // Load records from all content types
  parent.postMessage({ 
    pluginMessage: { 
      type: 'load-multiple-records', 
      config, 
      contentTypes: contentTypesToLoad,
      mappings: allMappings
    } 
  }, '*');
});

// Record navigation
document.getElementById('prev-record').addEventListener('click', () => {
  if (currentRecordIndex > 0) {
    currentRecordIndex--;
    displayCurrentRecord();
    applyRecordToNodes();
  }
});

document.getElementById('next-record').addEventListener('click', () => {
  if (currentRecordIndex < records.length - 1) {
    currentRecordIndex++;
    displayCurrentRecord();
    applyRecordToNodes();
  }
});

function displayCurrentRecord() {
  if (records.length === 0) return;
  
  const record = records[currentRecordIndex];
  const recordDataDiv = document.getElementById('record-data');
  recordDataDiv.innerHTML = '';
  
  // Update counter
  document.getElementById('record-counter').textContent = `Record ${currentRecordIndex + 1} of ${records.length}`;
  
  // Display record fields
  const fields = record.fields || {};
  Object.keys(fields).forEach(fieldKey => {
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'record-field';
    
    const fieldName = document.createElement('span');
    fieldName.className = 'field-name';
    fieldName.textContent = fieldKey;
    
    const fieldValue = document.createElement('span');
    fieldValue.className = 'field-value';
    fieldValue.textContent = sanitizeString(String(fields[fieldKey] || ''));
    fieldValue.title = String(fields[fieldKey] || '');
    
    fieldDiv.appendChild(fieldName);
    fieldDiv.appendChild(fieldValue);
    recordDataDiv.appendChild(fieldDiv);
  });
  
  // Update navigation buttons
  document.getElementById('prev-record').disabled = currentRecordIndex === 0;
  document.getElementById('next-record').disabled = currentRecordIndex === records.length - 1;
}

function applyRecordToNodes() {
  if (records.length === 0 || !records[currentRecordIndex]) return;
  
  const record = records[currentRecordIndex];
  const fields = record.fields || {};
  
  // Collect all mappings from all groups with content type info
  const allMappings = [];
  
  contentTypeGroups.forEach(group => {
    const container = document.querySelector(`.mappings-container[data-group-id="${group.id}"]`);
    
    if (container) {
      container.querySelectorAll('.mapping-item').forEach(item => {
        const fieldSelect = item.querySelector('.field-select');
        const nodeSelect = item.querySelector('.node-select');
        
        if (fieldSelect.value && nodeSelect.value) {
          allMappings.push({
            field: fieldSelect.value,
            node: nodeSelect.value,
            contentTypeId: group.contentType.sys.id
          });
        }
      });
    }
  });
  
  // Send to Figma to update nodes
  parent.postMessage({
    pluginMessage: {
      type: 'apply-record-to-nodes',
      mappings: allMappings,
      recordFields: fields
    }
  }, '*');
}

function createCombinedRecords(recordsByType) {
  // Create combined records by taking all combinations
  // For simplicity, we'll create records by taking index-aligned entries from each content type
  const contentTypeIds = Object.keys(recordsByType);
  
  if (contentTypeIds.length === 0) return [];
  
  // Find the max number of records across all content types
  let maxRecords = 0;
  contentTypeIds.forEach(ctId => {
    const count = recordsByType[ctId]?.length || 0;
    if (count > maxRecords) maxRecords = count;
  });
  
  // Create combined records
  const combined = [];
  for (let i = 0; i < maxRecords; i++) {
    const combinedFields = {};
    
    contentTypeIds.forEach(ctId => {
      const records = recordsByType[ctId] || [];
      const record = records[i] || records[0]; // Use first record if we run out
      
      if (record && record.fields) {
        // Merge fields, prefixing with content type ID to avoid collisions
        Object.keys(record.fields).forEach(fieldKey => {
          // Store both prefixed and unprefixed for flexibility
          combinedFields[`${ctId}.${fieldKey}`] = record.fields[fieldKey];
          // If no collision, also store without prefix
          if (!combinedFields[fieldKey]) {
            combinedFields[fieldKey] = record.fields[fieldKey];
          }
        });
      }
    });
    
    combined.push({
      sys: { id: `combined_${i}` },
      fields: combinedFields
    });
  }
  
  return combined;
}

// Message handler additions for content preview
const originalOnMessage = window.onmessage;
window.onmessage = (event) => {
  // Call original handler first
  if (originalOnMessage) {
    originalOnMessage(event);
  }
  
  if (!event || !event.data || !event.data.pluginMessage) return;
  const msg = event.data.pluginMessage;
  
  if (msg.type === 'content-types-loaded') {
    contentTypes = msg.contentTypes || [];
    const select = document.getElementById('content-type-select');
    select.innerHTML = '<option value="">Select content type...</option>';
    
    contentTypes.forEach(ct => {
      const opt = document.createElement('option');
      opt.value = ct.sys.id;
      opt.textContent = `${ct.name} (${ct.sys.id})`;
      select.appendChild(opt);
    });
    
    select.disabled = false;
    setPreviewStatus(`${contentTypes.length} content type(s) available`, 'success');
  }
  
  if (msg.type === 'text-nodes-loaded') {
    const nodes = msg.nodes || [];
    
    // Update all node selects
    document.querySelectorAll('.node-select').forEach(select => {
      const currentValue = select.value;
      select.innerHTML = '<option value="">Select node...</option>';
      
      nodes.forEach(node => {
        const opt = document.createElement('option');
        opt.value = node.id;
        opt.textContent = `${node.name} (${node.characters.substring(0, 20)}...)`;
        if (node.id === currentValue) {
          opt.selected = true;
        }
        select.appendChild(opt);
      });
    });
  }
  
  if (msg.type === 'records-loaded') {
    records = msg.records || [];
    currentRecordIndex = 0;
    
    if (records.length > 0) {
      document.getElementById('record-navigation').classList.remove('hidden');
      displayCurrentRecord();
      applyRecordToNodes();
      setPreviewStatus(`${records.length} record(s) loaded`, 'success');
    } else {
      setPreviewStatus('No records found', 'error');
    }
  }
  
  if (msg.type === 'multiple-records-loaded') {
    // msg.recordsByContentType is an object: { contentTypeId: [records] }
    const recordsByType = msg.recordsByContentType || {};
    
    // For now, use the first record from each content type to create combinations
    // This creates "combined" records for preview
    records = createCombinedRecords(recordsByType);
    currentRecordIndex = 0;
    
    if (records.length > 0) {
      document.getElementById('record-navigation').classList.remove('hidden');
      displayCurrentRecord();
      applyRecordToNodes();
      setPreviewStatus(`${records.length} combined record(s) loaded`, 'success');
    } else {
      setPreviewStatus('No records found', 'error');
    }
  }
  
  if (msg.type === 'record-applied') {
    // Success feedback could go here
  }
  
  // Write mode message handlers
  if (msg.type === 'translatable-nodes-loaded') {
    loadItemsAndCheckStatus(msg.nodes || []);
  }
  
  if (msg.type === 'contentful-items-loaded') {
    console.log('📥 Contentful items loaded from server:', Object.keys(msg.items || {}).length, 'items');
    contentfulItems = msg.items || {};
    
    // Log what we got from Contentful for debugging
    Object.keys(contentfulItems).forEach(key => {
      console.log(`  - ${key}: "${contentfulItems[key].value.substring(0, 50)}..." (ID: ${contentfulItems[key].id})`);
    });
    
    renderItemsTable();
    setWriteStatus('Ready', 'success');
  }
  
  if (msg.type === 'item-saved') {
    console.log('Received item-saved message:', msg);
    updateItemStatus(msg.key, msg.success, msg.error, msg.errorDetails);
  }
  
  // Handle text node selection in Figma canvas
  if (msg.type === 'text-node-selected') {
    const searchInput = document.getElementById('search-input');
    if (searchInput && msg.nodeName) {
      console.log('Text node selected in Figma:', msg.nodeName);
      searchInput.value = msg.nodeName;
      searchInput.dispatchEvent(new Event('input'));
    }
  }
};

// Error Modal Functions
function showErrorModal(title, message, details) {
  const modal = document.getElementById('error-modal');
  document.getElementById('error-modal-title').textContent = title;
  document.getElementById('error-modal-message').textContent = message;
  document.getElementById('error-modal-details').textContent = JSON.stringify(details, null, 2);
  modal.classList.add('show');
}

function hideErrorModal() {
  document.getElementById('error-modal').classList.remove('show');
}

function copyErrorToClipboard() {
  const details = document.getElementById('error-modal-details').textContent;
  const message = document.getElementById('error-modal-message').textContent;
  const title = document.getElementById('error-modal-title').textContent;
  
  const errorReport = `=== ${title} ===\n\n${message}\n\n=== Technical Details ===\n${details}`;
  
  navigator.clipboard.writeText(errorReport).then(() => {
    const btn = document.getElementById('btn-copy-error');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;"><path d="M10.8 2.74286L4.8 8.74286L1.71429 5.65714L2.74286 4.62857L4.8 6.68571L9.77143 1.71429L10.8 2.74286Z" fill="currentColor"/></svg> Copied!';
    setTimeout(() => {
      btn.innerHTML = originalText;
    }, 2000);
  }).catch(() => {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = errorReport;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
  });
}

// Validation Modal Functions
function showValidationModal() {
  document.getElementById('validation-modal').classList.add('show');
  // Hide close button during validation
  document.getElementById('validation-close-btn').style.display = 'none';
  document.getElementById('validation-footer').style.display = 'none';
  document.getElementById('validation-status').style.display = 'none';

  // Create the preflight steps
  createPreflightSteps();
}

function hideValidationModal() {
  document.getElementById('validation-modal').classList.remove('show');
  document.getElementById('validation-steps-container').innerHTML = '';
  document.getElementById('validation-status').style.display = 'none';
  document.getElementById('validation-status').innerHTML = '';
}

function createPreflightSteps() {
  const steps = [
    { id: 'preflight-validate', text: 'Validating configuration...' },
    { id: 'preflight-locales', text: 'Testing connection & fetching locales...' },
    { id: 'preflight-content', text: 'Verifying content type...' },
    { id: 'preflight-save', text: 'Saving configuration...' }
  ];

  const container = document.getElementById('validation-steps-container');
  container.innerHTML = '';

  steps.forEach(step => {
    const stepDiv = document.createElement('div');
    stepDiv.className = 'preflight-step';
    stepDiv.id = step.id;
    stepDiv.innerHTML = `
      <div class="preflight-icon">
        <svg class="spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="spinnerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:var(--figma-accent);stop-opacity:1" />
              <stop offset="100%" style="stop-color:var(--figma-accent);stop-opacity:0.3" />
            </linearGradient>
          </defs>
          <circle cx="12" cy="12" r="10" stroke="var(--figma-border)" stroke-width="3" opacity="0.2"/>
          <circle cx="12" cy="12" r="10" stroke="url(#spinnerGradient)" stroke-width="3" stroke-linecap="round" stroke-dasharray="15 50"/>
        </svg>
      </div>
      <div class="preflight-text">${step.text}</div>
    `;
    container.appendChild(stepDiv);
  });
}

</script>

<!-- Error Modal -->
<div id="error-modal" class="error-modal">
  <div class="error-modal-content">
    <div class="error-modal-header">
      <div class="error-modal-title" id="error-modal-title">Error</div>
      <button class="error-modal-close" onclick="hideErrorModal()">×</button>
    </div>
    <div class="error-modal-body">
      <div class="error-message" id="error-modal-message"></div>
      <div class="error-details" id="error-modal-details"></div>
    </div>
    <div class="error-modal-footer">
      <button class="btn-copy-error" id="btn-copy-error" onclick="copyErrorToClipboard()">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4px;">
          <path d="M9.6 0H2.4C1.74 0 1.2 0.54 1.2 1.2V8.4H2.4V1.2H9.6V0ZM11.4 2.4H4.8C4.14 2.4 3.6 2.94 3.6 3.6V10.8C3.6 11.46 4.14 12 4.8 12H11.4C12.06 12 12.6 11.46 12.6 10.8V3.6C12.6 2.94 12.06 2.4 11.4 2.4ZM11.4 10.8H4.8V3.6H11.4V10.8Z" fill="currentColor"/>
        </svg>
        Copy Error Details
      </button>
      <button class="btn-close-modal" onclick="hideErrorModal()">Close</button>
    </div>
  </div>
</div>

<!-- Reset Confirmation Modal -->
<div id="reset-modal" class="reset-modal">
  <div class="reset-modal-content">
    <div class="reset-modal-header">
      <div class="reset-modal-title">Reset All Fields?</div>
      <button class="reset-modal-close" onclick="hideResetModal()">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 4 L12 12 M12 4 L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="reset-modal-body">
      <p>Are you sure you want to reset all fields to their default values?</p>
      <p style="color: var(--figma-text-secondary); margin-top: 8px;">Any unsaved changes will be lost.</p>
    </div>
    <div class="reset-modal-footer">
      <button class="btn-secondary" onclick="hideResetModal()">Cancel</button>
      <button class="btn-danger" onclick="confirmReset()">Reset to Default</button>
    </div>
  </div>
</div>

<!-- Validation Modal -->
<div id="validation-modal" class="validation-modal">
  <div class="validation-modal-content">
    <div class="validation-modal-header">
      <div class="validation-modal-title">Validating Configuration</div>
      <button class="validation-modal-close" onclick="hideValidationModal()" id="validation-close-btn" style="display: none;">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 4 L12 12 M12 4 L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="validation-modal-body">
      <div id="validation-steps-container"></div>
      <div id="validation-status" style="margin-top: 16px; display: none;"></div>
    </div>
    <div class="validation-modal-footer" id="validation-footer" style="display: none;">
      <button class="btn-primary" onclick="hideValidationModal()">Close</button>
    </div>
  </div>
</div>

</script>
